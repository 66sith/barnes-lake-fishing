<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
<title>Barnes Lake Fishing â€” Live Forecast & Depth Map</title>
<meta name="description" content="Live fishing forecast, solunar activity, species targeting, and depth map for Barnes Lake, Lapeer County, Michigan">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="Barnes Lake">
<link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#0a1628" media="(prefers-color-scheme: dark)">
<meta name="theme-color" content="#0a1628" media="(prefers-color-scheme: light)">
<link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
<link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
<style>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESIGN SYSTEM â€” PREMIUM FISHING BRAND
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
:root {
  --bg-deep: #0a1628;
  --bg-mid: #0f1f35;
  --bg-surface: #162a46;
  --bg-glass: rgba(15, 31, 53, 0.72);
  --bg-glass-heavy: rgba(10, 22, 40, 0.92);
  --gold: #d4a843;
  --gold-light: #e8c76a;
  --gold-dark: #b08930;
  --teal: #00d4aa;
  --teal-dim: rgba(0, 212, 170, 0.15);
  --text-primary: #f0f4f8;
  --text-secondary: #8899aa;
  --text-muted: #556677;
  --score-excellent: #22c55e;
  --score-great: #4ade80;
  --score-good: #a3e635;
  --score-fair: #f59e0b;
  --score-poor: #ef4444;
  --border: rgba(255,255,255,0.06);
  --border-light: rgba(255,255,255,0.10);
  --shadow: 0 8px 32px rgba(0,0,0,0.5);
  --shadow-lg: 0 16px 48px rgba(0,0,0,0.6);
  --radius: 14px;
  --radius-lg: 18px;
  --radius-xl: 24px;
  --font: -apple-system, BlinkMacSystemFont, 'SF Pro Display', system-ui, sans-serif;
  --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
  --ease-out: cubic-bezier(0.2, 0, 0, 1);
  --safe-top: env(safe-area-inset-top, 0px);
  --safe-bottom: env(safe-area-inset-bottom, 0px);
  --safe-left: env(safe-area-inset-left, 0px);
  --safe-right: env(safe-area-inset-right, 0px);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   RESET & BASE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
html { -webkit-text-size-adjust: 100%; }
html, body {
  width: 100%; height: 100%;
  font-family: var(--font);
  background: var(--bg-deep);
  color: var(--text-primary);
  overflow: hidden;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
  touch-action: manipulation;
}
body { position: relative; }
::-webkit-scrollbar { width: 3px; height: 3px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.15); border-radius: 2px; }
a { color: var(--teal); text-decoration: none; }
a:hover { text-decoration: underline; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPLASH / LOADING SCREEN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#splash {
  position: fixed; inset: 0; z-index: 9999;
  background: var(--bg-deep);
  display: flex; flex-direction: column;
  align-items: center; justify-content: center;
  transition: opacity 0.5s var(--ease-out), visibility 0.5s var(--ease-out);
}
#splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
.splash-ring {
  width: 80px; height: 80px;
  border: 3px solid transparent;
  border-top-color: var(--gold);
  border-radius: 50%;
  animation: spin 1s linear infinite;
}
@keyframes spin { to { transform: rotate(360deg); } }
.splash-title { margin-top: 20px; font-size: 20px; font-weight: 700; color: var(--gold); letter-spacing: 1px; }
.splash-sub { margin-top: 6px; font-size: 13px; color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   MAP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#map { position: absolute; inset: 0; width: 100%; height: 100%; }
.maplibregl-ctrl-bottom-left, .maplibregl-ctrl-bottom-right { bottom: 100px; }
@media (min-width: 1024px) {
  .maplibregl-ctrl-bottom-left, .maplibregl-ctrl-bottom-right { bottom: 10px; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HEADER â€” TOP LEFT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#header {
  position: fixed; top: calc(12px + var(--safe-top)); left: calc(12px + var(--safe-left));
  z-index: 100;
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid var(--border);
  border-radius: var(--radius-lg);
  padding: 14px 18px;
  box-shadow: var(--shadow);
  max-width: 280px;
}
#header h1 { font-size: 18px; font-weight: 700; display: flex; align-items: center; gap: 8px; }
#header .subtitle { font-size: 11px; color: var(--text-muted); margin: 2px 0 8px; }
.cond-row { display: flex; gap: 14px; font-size: 12px; color: var(--text-secondary); }
.cond-item { display: flex; align-items: center; gap: 4px; white-space: nowrap; }
.cond-val { color: var(--text-primary); font-weight: 600; }
.trend-arrow { font-size: 14px; }
.trend-arrow.rising { color: var(--score-excellent); }
.trend-arrow.falling { color: var(--score-poor); }
.trend-arrow.steady { color: var(--text-secondary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   VIEW SWITCHER â€” TOP RIGHT
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#views {
  position: fixed; top: calc(12px + var(--safe-top)); right: calc(12px + var(--safe-right));
  z-index: 100;
  background: var(--bg-glass);
  backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  display: flex; overflow: hidden;
  box-shadow: var(--shadow);
}
#views button {
  border: none; background: transparent;
  color: var(--text-secondary);
  font-family: var(--font); font-size: 12px; font-weight: 600;
  padding: 10px 16px; min-height: 44px;
  cursor: pointer; transition: all 180ms var(--ease-out);
  letter-spacing: 0.5px;
  border-right: 1px solid var(--border);
}
#views button:last-child { border-right: none; }
#views button.active { background: var(--gold); color: var(--bg-deep); }
#views button:active:not(.active) { background: rgba(212, 168, 67, 0.15); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS BUTTON
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settings-btn {
  position: fixed; top: calc(60px + var(--safe-top)); right: calc(12px + var(--safe-right));
  z-index: 100; width: 44px; height: 44px;
  background: var(--bg-glass);
  backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border: 1px solid var(--border);
  border-radius: 50%;
  display: flex; align-items: center; justify-content: center;
  cursor: pointer; color: var(--text-secondary);
  box-shadow: var(--shadow);
  transition: all 180ms var(--ease-out);
}
#settings-btn:active { transform: scale(0.92); }
#settings-btn svg { width: 18px; height: 18px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SETTINGS PANEL
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#settings-panel {
  position: fixed; top: 0; right: -340px; bottom: 0;
  width: 320px; z-index: 300;
  background: var(--bg-glass-heavy);
  backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
  border-left: 1px solid var(--border);
  padding: 24px 20px;
  padding-top: calc(24px + var(--safe-top));
  padding-right: calc(20px + var(--safe-right));
  transition: right 0.4s var(--spring);
  overflow-y: auto;
}
#settings-panel.open { right: 0; }
.settings-backdrop {
  position: fixed; inset: 0; z-index: 299;
  background: rgba(0,0,0,0.5);
  opacity: 0; visibility: hidden;
  transition: opacity 0.3s ease, visibility 0.3s ease;
}
.settings-backdrop.open { opacity: 1; visibility: visible; }
.settings-head {
  font-size: 18px; font-weight: 700; margin-bottom: 24px;
  display: flex; justify-content: space-between; align-items: center;
}
.settings-close {
  background: none; border: none; color: var(--text-secondary);
  cursor: pointer; padding: 8px; min-width: 44px; min-height: 44px;
  display: flex; align-items: center; justify-content: center;
}
.settings-close:active { color: var(--text-primary); }
.setting-group { margin-bottom: 20px; }
.setting-label {
  font-size: 11px; color: var(--text-muted); text-transform: uppercase;
  letter-spacing: 1.2px; margin-bottom: 10px; font-weight: 700;
}
.setting-row {
  display: flex; justify-content: space-between; align-items: center;
  padding: 12px 0; border-bottom: 1px solid var(--border);
  min-height: 44px;
}
.setting-row span { font-size: 14px; }
.toggle {
  width: 50px; height: 30px; border-radius: 15px;
  background: var(--bg-surface); border: 1px solid var(--border-light);
  position: relative; cursor: pointer;
  transition: background 0.3s ease;
  flex-shrink: 0;
}
.toggle.on { background: var(--gold); border-color: var(--gold); }
.toggle::after {
  content: ''; position: absolute;
  width: 24px; height: 24px; border-radius: 50%;
  background: white; top: 2px; left: 2px;
  transition: transform 0.25s var(--spring);
  box-shadow: 0 2px 6px rgba(0,0,0,0.25);
}
.toggle.on::after { transform: translateX(20px); }
.settings-disclaimer {
  margin-top: 24px; padding: 14px;
  background: rgba(245, 158, 11, 0.08);
  border: 1px solid rgba(245, 158, 11, 0.15);
  border-radius: var(--radius);
  font-size: 11px; color: var(--score-fair);
  line-height: 1.6;
}
.settings-about {
  margin-top: 16px; font-size: 12px; color: var(--text-muted);
  line-height: 1.7;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM SHEET BACKDROP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#sheet-backdrop {
  position: fixed; inset: 0; z-index: 149;
  background: rgba(0,0,0,0.4);
  opacity: 0; pointer-events: none;
  transition: opacity 0.3s ease;
}
#sheet-backdrop.active { opacity: 1; pointer-events: auto; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BOTTOM SHEET â€” iOS-NATIVE PHYSICS
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (max-width: 1023px) {
  #sheet {
    position: fixed; left: 0; right: 0; bottom: 0;
    z-index: 150;
    background: var(--bg-glass-heavy);
    backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
    border-top: 1px solid var(--border-light);
    border-radius: var(--radius-xl) var(--radius-xl) 0 0;
    box-shadow: 0 -12px 40px rgba(0,0,0,0.4);
    will-change: transform;
    overflow: hidden;
    overscroll-behavior-y: contain;
  }
  .sheet-handle {
    width: 100%; height: 44px;
    display: flex; align-items: center; justify-content: center;
    cursor: grab; touch-action: none; flex-shrink: 0;
  }
  .sheet-handle-pill {
    width: 36px; height: 5px;
    background: var(--text-muted); border-radius: 3px; opacity: 0.4;
  }
  .sheet-peek {
    display: flex; align-items: center; justify-content: space-between;
    padding: 0 20px 14px;
    padding-left: calc(20px + var(--safe-left));
    padding-right: calc(20px + var(--safe-right));
    flex-shrink: 0;
  }
  .peek-score { font-size: 36px; font-weight: 800; font-variant-numeric: tabular-nums; }
  .peek-label { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
  .peek-next { text-align: right; font-size: 13px; color: var(--text-secondary); line-height: 1.4; }
  .peek-next strong { color: var(--gold); font-weight: 600; }
  .sheet-content {
    overflow-y: auto; overscroll-behavior-y: contain;
    -webkit-overflow-scrolling: touch;
    padding: 0 20px 20px;
    padding-left: calc(20px + var(--safe-left));
    padding-right: calc(20px + var(--safe-right));
    padding-bottom: calc(24px + var(--safe-bottom));
    display: flex; flex-direction: column; gap: 24px;
  }
}
@media (min-width: 1024px) {
  #sheet { display: none !important; }
  #sheet-backdrop { display: none !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DESKTOP SIDEBAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
@media (min-width: 1024px) {
  #sidebar {
    position: fixed; top: 0; left: 0; bottom: 0;
    width: 420px; z-index: 50;
    background: var(--bg-glass-heavy);
    backdrop-filter: blur(40px) saturate(180%); -webkit-backdrop-filter: blur(40px) saturate(180%);
    border-right: 1px solid var(--border);
    overflow-y: auto; overflow-x: hidden;
    padding: 20px 24px;
    padding-top: calc(20px + var(--safe-top));
    display: flex; flex-direction: column; gap: 24px;
    scrollbar-width: thin; scroll-behavior: smooth;
  }
  #map { left: 420px; width: calc(100% - 420px); }
  #header { left: calc(432px + var(--safe-left)); }
  .maplibregl-ctrl-bottom-left { left: 420px; }
}
@media (max-width: 1023px) {
  #sidebar { display: none !important; }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SECTION TITLES
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.sec-title {
  font-size: 11px; font-weight: 700; text-transform: uppercase;
  letter-spacing: 1.5px; color: var(--text-muted);
  margin-bottom: 14px;
  display: flex; align-items: center; gap: 8px;
  padding-left: 14px;
  border-left: 3px solid var(--gold);
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   JEFF BANNER â€” CHAMPIONSHIP TROPHY QUALITY
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.jeff-banner { text-align: center; padding: 16px 0 8px; position: relative; overflow: hidden; }
.jeff-title {
  font-size: 32px; font-weight: 900; letter-spacing: 4px; text-transform: uppercase;
  line-height: 1.2;
  background: linear-gradient(
    180deg,
    var(--gold-light) 0%,
    var(--gold) 30%,
    var(--gold-dark) 50%,
    var(--gold) 70%,
    var(--gold-light) 100%
  );
  background-size: 100% 200%;
  -webkit-background-clip: text; -webkit-text-fill-color: transparent;
  background-clip: text;
  animation: goldShimmer 6s ease-in-out infinite;
  filter: drop-shadow(0 2px 4px rgba(180, 140, 50, 0.4));
}
.jeff-sub {
  font-size: 11px; color: var(--gold-dark); margin-top: 6px;
  letter-spacing: 4px; font-weight: 700; text-transform: uppercase;
}
@keyframes goldShimmer {
  0%, 100% { background-position: 0% 0%; }
  50% { background-position: 0% 100%; }
}
/* CSS-only ember particles */
.jeff-banner::before, .jeff-banner::after {
  content: ''; position: absolute; width: 4px; height: 4px; border-radius: 50%;
  background: radial-gradient(circle, var(--gold-light) 0%, transparent 70%);
  opacity: 0; pointer-events: none;
}
.jeff-banner::before {
  left: 30%; bottom: 10px;
  animation: ember 4s ease-out infinite 0.5s;
}
.jeff-banner::after {
  left: 65%; bottom: 8px;
  animation: ember 5s ease-out infinite 2s;
}
@keyframes ember {
  0% { opacity: 0; transform: translateY(0) scale(1); }
  20% { opacity: 0.8; }
  100% { opacity: 0; transform: translateY(-40px) scale(0.3); }
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   GAUGE â€” SVG ARC WITH GLOW
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.gauge-wrap { display: flex; flex-direction: column; align-items: center; padding: 4px 0; }
.gauge-svg { width: 200px; height: 150px; }
.gauge-score-text {
  font-size: 56px; font-weight: 800;
  font-variant-numeric: tabular-nums;
}
.gauge-label-text { font-size: 14px; font-weight: 600; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   HOURLY TIMELINE â€” THE KILLER FEATURE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timeline-scroll {
  display: flex; overflow-x: auto; overflow-y: hidden;
  -webkit-overflow-scrolling: touch;
  scroll-snap-type: x proximity;
  padding-bottom: 4px;
  gap: 0;
}
.timeline-scroll::-webkit-scrollbar { height: 2px; }
.timeline-col {
  flex: 0 0 48px; scroll-snap-align: start;
  display: flex; flex-direction: column; align-items: center;
  border-right: 1px solid var(--border);
  padding: 6px 0;
  cursor: pointer;
  transition: background 180ms var(--ease-out);
  position: relative;
}
.timeline-col:active { background: rgba(255,255,255,0.04); }
.timeline-col.now { background: rgba(212, 168, 67, 0.12); }
.timeline-col.now::after {
  content: ''; position: absolute; top: 0; left: 0; right: 0; height: 3px;
  background: var(--gold);
}
.timeline-col.best-window { background: rgba(212, 168, 67, 0.06); }
.timeline-hour { font-size: 10px; color: var(--text-muted); font-weight: 600; margin-bottom: 4px; }
.timeline-col.now .timeline-hour { color: var(--gold); }
.timeline-score { font-size: 16px; font-weight: 800; margin-bottom: 3px; font-variant-numeric: tabular-nums; }
.timeline-bars {
  display: flex; flex-direction: column; gap: 2px; width: 28px; margin-bottom: 4px;
}
.timeline-bar-item {
  height: 4px; border-radius: 2px; min-width: 2px;
  transition: width 0.3s ease;
}
.timeline-solunar {
  width: 100%; height: 8px; position: relative;
}
.timeline-solunar-fill {
  position: absolute; inset: 0;
  border-radius: 2px;
}
.timeline-solunar-fill.major { background: rgba(212, 168, 67, 0.6); }
.timeline-solunar-fill.minor { background: rgba(212, 168, 67, 0.3); }
.timeline-sun-marker {
  position: absolute; bottom: -2px; font-size: 8px; transform: translateX(-50%);
}

/* Timeline detail popup */
.timeline-popup {
  position: fixed; z-index: 200;
  background: var(--bg-glass-heavy);
  backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 14px 16px;
  box-shadow: var(--shadow-lg);
  min-width: 180px; max-width: 240px;
  opacity: 0; transform: translateY(8px) scale(0.95);
  transition: opacity 0.2s ease, transform 0.25s var(--spring);
  pointer-events: none;
}
.timeline-popup.visible {
  opacity: 1; transform: translateY(0) scale(1); pointer-events: auto;
}
.popup-hour { font-size: 14px; font-weight: 700; margin-bottom: 8px; color: var(--gold); }
.popup-species { font-size: 12px; line-height: 1.6; }
.popup-species-row { display: flex; justify-content: space-between; align-items: center; }
.popup-species-name { color: var(--text-secondary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SOLUNAR TIMELINE BAR
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.solunar-wrap {
  background: var(--bg-surface);
  border-radius: var(--radius);
  padding: 14px;
}
.sol-bar { position: relative; height: 32px; background: var(--bg-deep); border-radius: 8px; overflow: hidden; }
.sol-block {
  position: absolute; top: 0; height: 100%; border-radius: 4px; opacity: 0.7;
}
.sol-block.major { background: var(--gold); }
.sol-block.minor { background: rgba(212, 168, 67, 0.35); }
.sol-now {
  position: absolute; top: -4px; bottom: -4px;
  width: 2px; background: var(--teal); z-index: 2;
}
.sol-now::after {
  content: 'NOW'; position: absolute; top: -14px;
  left: 50%; transform: translateX(-50%);
  font-size: 8px; font-weight: 800; color: var(--teal);
  letter-spacing: 0.5px;
}
.sol-labels {
  display: flex; justify-content: space-between;
  margin-top: 6px; font-size: 10px; color: var(--text-muted);
}
.sol-events { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
.sol-event {
  display: flex; align-items: center; gap: 4px;
  font-size: 11px; color: var(--text-secondary);
  background: var(--bg-deep); padding: 5px 10px; border-radius: 8px;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   FACTOR BREAKDOWN
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.factors-list { display: flex; flex-direction: column; gap: 10px; }
.factor-row { display: flex; align-items: center; gap: 10px; }
.factor-icon { font-size: 16px; width: 22px; text-align: center; flex-shrink: 0; }
.factor-name { font-size: 12px; color: var(--text-secondary); width: 82px; flex-shrink: 0; }
.factor-track {
  flex: 1; height: 8px; background: var(--bg-deep);
  border-radius: 4px; overflow: hidden;
}
.factor-fill {
  height: 100%; border-radius: 4px;
  transition: width 1s var(--ease-out);
}
.factor-val {
  font-size: 12px; font-weight: 700; width: 30px; text-align: right;
  flex-shrink: 0; font-variant-numeric: tabular-nums;
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   SPECIES CARDS â€” COMMERCIAL GRADE
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.species-grid {
  display: flex; flex-direction: column; gap: 12px;
}
.sp-card {
  background: linear-gradient(135deg, var(--bg-surface) 0%, var(--bg-mid) 100%);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 16px;
  transition: border-color 180ms var(--ease-out), transform 180ms var(--ease-out);
}
.sp-card:active { transform: scale(0.985); }
.sp-top { display: flex; align-items: flex-start; justify-content: space-between; margin-bottom: 10px; }
.sp-info { display: flex; align-items: center; gap: 10px; }
.sp-emoji { font-size: 28px; }
.sp-name { font-size: 14px; font-weight: 700; line-height: 1.2; }
.sp-depth { font-size: 11px; color: var(--text-muted); margin-top: 2px; }
.sp-score-wrap { text-align: right; }
.sp-score { font-size: 32px; font-weight: 800; font-variant-numeric: tabular-nums; }
.sp-status { font-size: 11px; font-weight: 700; }
.sp-sparkline { margin: 8px 0; }
.sp-sparkline svg { width: 100%; height: 32px; }
.sp-baits { display: flex; flex-direction: column; gap: 6px; }
.sp-bait {
  display: flex; align-items: center; gap: 8px;
  font-size: 12px; color: var(--text-secondary);
  background: var(--bg-deep); border-radius: 8px; padding: 8px 12px;
}
.sp-bait-name { font-weight: 600; color: var(--text-primary); flex-shrink: 0; }
.sp-bait-reason { flex: 1; font-size: 11px; color: var(--text-muted); }
.sp-bait-link {
  flex-shrink: 0; width: 32px; height: 32px;
  display: flex; align-items: center; justify-content: center;
  background: rgba(0, 212, 170, 0.1); border-radius: 8px;
  color: var(--teal); transition: background 180ms;
}
.sp-bait-link:active { background: rgba(0, 212, 170, 0.2); }
.sp-bait-link:hover { text-decoration: none; }
.sp-bait-link svg { width: 16px; height: 16px; }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   7-DAY OUTLOOK
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.outlook-scroll {
  display: flex; gap: 10px;
  overflow-x: auto; overflow-y: hidden;
  scroll-snap-type: x mandatory;
  padding-bottom: 4px;
  -webkit-overflow-scrolling: touch;
}
.outlook-card {
  flex: 0 0 105px; scroll-snap-align: start;
  background: var(--bg-surface);
  border: 1px solid var(--border);
  border-radius: var(--radius);
  padding: 12px; text-align: center;
  transition: transform 180ms var(--ease-out);
}
.outlook-card:active { transform: scale(0.96); }
.outlook-day { font-size: 12px; font-weight: 700; margin-bottom: 6px; }
.outlook-day.today { color: var(--gold); }
.outlook-icon { font-size: 24px; margin-bottom: 4px; }
.outlook-temps { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
.outlook-temps .hi { color: var(--text-primary); font-weight: 600; }
.outlook-mini { font-size: 22px; font-weight: 800; font-variant-numeric: tabular-nums; margin-bottom: 2px; }
.outlook-sp { font-size: 10px; color: var(--text-muted); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   DEPTH TOOLTIP
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
#depth-tooltip {
  position: fixed; z-index: 200;
  background: var(--bg-glass-heavy);
  backdrop-filter: blur(30px); -webkit-backdrop-filter: blur(30px);
  border: 1px solid var(--border-light);
  border-radius: var(--radius);
  padding: 14px 16px;
  box-shadow: var(--shadow-lg);
  pointer-events: none;
  opacity: 0; transform: translateY(4px);
  transition: opacity 0.2s ease, transform 0.25s var(--spring);
  max-width: 220px;
}
#depth-tooltip.visible { opacity: 1; transform: translateY(0); pointer-events: auto; }
.tt-depth { font-size: 22px; font-weight: 800; margin-bottom: 4px; }
.tt-zone { font-size: 12px; color: var(--text-secondary); margin-bottom: 8px; }
.tt-species { font-size: 11px; color: var(--text-muted); line-height: 1.5; }
.tt-species strong { color: var(--text-secondary); }

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PERFORMANCE LAYER
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
.timeline-scroll, .outlook-scroll { will-change: scroll-position; contain: layout style; }
#header, #views, #settings-btn { transform: translate3d(0,0,0); }
</style>
</head>
<body>

<!-- â•â•â•â•â•â•â• SPLASH â•â•â•â•â•â•â• -->
<div id="splash">
  <div class="splash-ring"></div>
  <div class="splash-title">Barnes Lake</div>
  <div class="splash-sub">Loading forecast &amp; depth data...</div>
</div>

<!-- â•â•â•â•â•â•â• MAP â•â•â•â•â•â•â• -->
<div id="map"></div>

<!-- â•â•â•â•â•â•â• HEADER â•â•â•â•â•â•â• -->
<header id="header">
  <h1>
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M6.5 12c.94-3.46 4.94-6 8.5-6 3.56 0 6.06 2.54 7 6"/><path d="M6.5 12a4 4 0 0 1-4 4"/><path d="M18 22l4-4-4-4"/><path d="M2 16h20"/></svg>
    Barnes Lake
  </h1>
  <div class="subtitle">Lapeer County, MI &middot; 149 acres</div>
  <div class="cond-row">
    <div class="cond-item"><span id="cond-temp" class="cond-val">--</span>&deg;F</div>
    <div class="cond-item"><span id="cond-wind" class="cond-val">--</span> mph <span id="cond-wind-dir"></span></div>
    <div class="cond-item"><span id="cond-pressure" class="cond-val">--</span> mb <span id="pressure-arrow" class="trend-arrow"></span></div>
  </div>
</header>

<!-- â•â•â•â•â•â•â• VIEW SWITCHER â•â•â•â•â•â•â• -->
<nav id="views">
  <button data-view="satellite">SAT</button>
  <button data-view="topo">TOPO</button>
  <button data-view="depth">DEPTH</button>
  <button class="active" data-view="hybrid">HYB</button>
</nav>

<!-- â•â•â•â•â•â•â• SETTINGS BUTTON â•â•â•â•â•â•â• -->
<div id="settings-btn" role="button" aria-label="Settings" tabindex="0">
  <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1-2.83 2.83l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-4 0v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83-2.83l.06-.06A1.65 1.65 0 0 0 4.68 15a1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1 0-4h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 2.83-2.83l.06.06A1.65 1.65 0 0 0 9 4.68a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 4 0v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 2.83l-.06.06A1.65 1.65 0 0 0 19.4 9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 0 4h-.09a1.65 1.65 0 0 0-1.51 1z"/></svg>
</div>

<!-- â•â•â•â•â•â•â• SETTINGS PANEL â•â•â•â•â•â•â• -->
<div class="settings-backdrop" id="settings-backdrop"></div>
<div id="settings-panel">
  <div class="settings-head">
    Settings
    <button class="settings-close" aria-label="Close settings">
      <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 6L6 18M6 6l12 12"/></svg>
    </button>
  </div>
  <div class="setting-group">
    <div class="setting-label">Units</div>
    <div class="setting-row">
      <span>Temperature &deg;F</span>
      <div id="toggle-temp" class="toggle on" role="switch" aria-checked="true"></div>
    </div>
    <div class="setting-row">
      <span>Wind mph</span>
      <div id="toggle-wind" class="toggle on" role="switch" aria-checked="true"></div>
    </div>
  </div>
  <div class="setting-group">
    <div class="setting-label">Display</div>
    <div class="setting-row">
      <span>Screen Wake Lock</span>
      <div id="toggle-wake" class="toggle on" role="switch" aria-checked="true"></div>
    </div>
  </div>
  <div class="settings-disclaimer">
    Depth contours are estimated based on lake morphology and are NOT based on professional surveys. Not for navigation. Always use caution on the water.
  </div>
  <div class="settings-about">
    <strong>Barnes Lake Fishing</strong><br>
    Lapeer County, Michigan<br>
    43.1845&deg;N / 83.3025&deg;W &middot; 149 acres<br><br>
    Weather: <a href="https://open-meteo.com/" target="_blank" rel="noopener">Open-Meteo</a> (CC-BY 4.0)<br>
    Solunar: SunCalc (MIT)<br>
    Map: MapLibre GL (BSD-3) + Esri + OpenTopoMap<br><br>
    &copy; 2026 wasubihq.com
  </div>
</div>

<!-- â•â•â•â•â•â•â• DESKTOP SIDEBAR â•â•â•â•â•â•â• -->
<aside id="sidebar"></aside>

<!-- â•â•â•â•â•â•â• MOBILE BOTTOM SHEET â•â•â•â•â•â•â• -->
<div id="sheet-backdrop"></div>
<div id="sheet">
  <div class="sheet-handle"><div class="sheet-handle-pill"></div></div>
  <div class="sheet-peek">
    <div>
      <div class="peek-score" id="peek-score">--</div>
      <div class="peek-label">Bite Score</div>
    </div>
    <div class="peek-next" id="peek-next">Loading...</div>
  </div>
  <div class="sheet-content" id="sheet-content"></div>
</div>

<!-- â•â•â•â•â•â•â• DEPTH TOOLTIP â•â•â•â•â•â•â• -->
<div id="depth-tooltip">
  <div class="tt-depth" id="tt-depth"></div>
  <div class="tt-zone" id="tt-zone"></div>
  <div class="tt-species" id="tt-species"></div>
</div>

<!-- â•â•â•â•â•â•â• TIMELINE POPUP â•â•â•â•â•â•â• -->
<div class="timeline-popup" id="timeline-popup">
  <div class="popup-hour" id="popup-hour"></div>
  <div class="popup-species" id="popup-species"></div>
</div>

<!-- â•â•â•â•â•â•â• CDN â•â•â•â•â•â•â• -->
<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>

<script>
/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   BARNES LAKE FISHING â€” COMMERCIAL-GRADE PWA
   Â© 2026 wasubihq.com â€” F' YOU JEFF!
   â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */

// â”€â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const CFG = {
  LAT: 43.1845,
  LON: -83.3025,
  ZOOM: 14.5,
  PITCH: 45,
  BEARING: -15,
  MIN_ZOOM: 12,
  MAX_ZOOM: 18,
  CACHE_TTL: 30 * 60 * 1000,
  MAPTILER_KEY: 'lCFymMRzz2VIFlynCKcT'
};

// â”€â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let map = null;
let weatherData = null;
let currentView = 'hybrid';
let hourlyScores = null;
let bestWindows = [];
let wakeLock = null;
let settings = loadSettings();

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('bl_settings'));
    if (s) return s;
  } catch(e) {}
  return { tempUnit: 'F', windUnit: 'mph', wakeLock: true };
}
function saveSettings() {
  localStorage.setItem('bl_settings', JSON.stringify(settings));
}

// â”€â”€â”€ TILE SOURCES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const TILES = {
  satellite: {
    type: 'raster',
    tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
    tileSize: 256, maxzoom: 19, attribution: 'Esri'
  },
  topo: {
    type: 'raster',
    tiles: ['https://tile.opentopomap.org/{z}/{x}/{y}.png'],
    tileSize: 256, maxzoom: 17, attribution: 'OpenTopoMap'
  }
};

// â”€â”€â”€ SPECIES DATABASE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const SPECIES = [
  {
    id: 'largemouth', name: 'Largemouth Bass', emoji: 'ğŸŸ',
    tempMin: 65, tempMax: 80, peakMonths: [5,6,7,8,9],
    depthMin: 5, depthMax: 15,
    baits: [
      { name: 'Plastic Worms', reason: 'Versatile in all conditions', search: 'senko+worm+bass+fishing' },
      { name: 'Spinnerbaits', reason: 'Cover water fast, triggers reaction strikes', search: 'spinnerbait+bass+fishing' },
      { name: 'Crankbaits', reason: 'Matches baitfish profile', search: 'crankbait+bass+fishing+lure' },
      { name: 'Topwater Frogs', reason: 'Explosive surface strikes in cover', search: 'topwater+frog+bass+fishing' },
      { name: 'Jigs', reason: 'Slow presentations for pressured fish', search: 'bass+jig+fishing+lure' },
      { name: 'Swimbaits', reason: 'Big bait = big bass', search: 'swimbait+bass+fishing+lure' }
    ],
    windPref: 'moderate', skyPref: 'overcast'
  },
  {
    id: 'smallmouth', name: 'Smallmouth Bass', emoji: 'ğŸ ',
    tempMin: 60, tempMax: 75, peakMonths: [5,6,7,8,9,10],
    depthMin: 8, depthMax: 25,
    baits: [
      { name: 'Tube Jigs', reason: 'Mimics crawfish perfectly', search: 'tube+jig+smallmouth+bass' },
      { name: 'Drop Shot', reason: 'Finesse for clear water', search: 'drop+shot+rig+bass+fishing' },
      { name: 'Ned Rigs', reason: 'Slow fall drives them crazy', search: 'ned+rig+bass+fishing' },
      { name: 'Crankbaits', reason: 'Cover rocky structure fast', search: 'crankbait+smallmouth+bass' },
      { name: 'Jerkbaits', reason: 'Suspend and twitch in cold water', search: 'jerkbait+smallmouth+bass' },
      { name: 'Swimbaits', reason: 'Natural baitfish action', search: 'swimbait+smallmouth+bass' }
    ],
    windPref: 'moderate', skyPref: 'partly'
  },
  {
    id: 'pike', name: 'Northern Pike', emoji: 'ğŸ¦ˆ',
    tempMin: 55, tempMax: 70, peakMonths: [3,4,5,6,9,10,11],
    depthMin: 5, depthMax: 20,
    baits: [
      { name: 'Large Spoons', reason: 'Flash and vibration in murky water', search: 'pike+spoon+fishing+lure' },
      { name: 'Swimbaits', reason: 'Big profile triggers predator instinct', search: 'pike+swimbait+fishing+lure' },
      { name: 'Jerkbaits', reason: 'Erratic action mimics injured prey', search: 'pike+jerkbait+fishing+lure' },
      { name: 'Sucker Minnows', reason: 'Live bait under a bobber is deadly', search: 'sucker+minnow+pike+fishing' },
      { name: 'Bucktail Spinners', reason: 'Classic pike catcher, covers water fast', search: 'bucktail+spinner+pike+fishing' }
    ],
    windPref: 'any', skyPref: 'overcast'
  },
  {
    id: 'crappie', name: 'Crappie', emoji: 'ğŸ¡',
    tempMin: 55, tempMax: 68, peakMonths: [4,5,6],
    depthMin: 8, depthMax: 20,
    baits: [
      { name: 'Small Jigs', reason: '1/32oz under slip float is money', search: 'crappie+jig+fishing+lure' },
      { name: 'Live Minnows', reason: 'Nothing beats the real thing', search: 'crappie+minnow+hook+fishing' },
      { name: 'Bobber Rigs', reason: 'Suspend at the right depth', search: 'slip+bobber+crappie+fishing' },
      { name: 'Micro Plastics', reason: 'Curly tail grubs in chartreuse', search: 'micro+plastic+crappie+fishing' },
      { name: 'Marabou Jigs', reason: 'Natural breathing action', search: 'marabou+jig+crappie+fishing' }
    ],
    windPref: 'calm', skyPref: 'overcast'
  },
  {
    id: 'bluegill', name: 'Bluegill', emoji: 'ğŸŒŠ',
    tempMin: 65, tempMax: 80, peakMonths: [5,6,7,8],
    depthMin: 3, depthMax: 12,
    baits: [
      { name: 'Worms', reason: 'Simple and deadly â€” never fails', search: 'fishing+worms+hooks+bluegill' },
      { name: 'Crickets', reason: 'Live crickets on a #8 hook', search: 'live+crickets+fishing+bait' },
      { name: 'Small Jigs', reason: '1/64oz in bright colors', search: 'panfish+jig+bluegill+fishing' },
      { name: 'Fly Poppers', reason: 'Surface action on a fly rod', search: 'fly+popper+bluegill+panfish' },
      { name: 'Wax Worms', reason: 'Irresistible under a bobber', search: 'wax+worms+fishing+bait' }
    ],
    windPref: 'calm', skyPref: 'any'
  },
  {
    id: 'perch', name: 'Yellow Perch', emoji: 'ğŸŸ¡',
    tempMin: 55, tempMax: 70, peakMonths: [3,4,5,10,11],
    depthMin: 10, depthMax: 30,
    baits: [
      { name: 'Minnows', reason: 'Small fatheads on a spreader rig', search: 'perch+minnow+fishing+rig' },
      { name: 'Small Jigs', reason: 'Vertical jig near bottom', search: 'perch+jig+fishing+lure' },
      { name: 'Wax Worms', reason: 'Tip your jig for extra attraction', search: 'wax+worms+perch+fishing' },
      { name: 'Spreader Rigs', reason: 'Fish two baits at different depths', search: 'spreader+rig+perch+fishing' },
      { name: 'Beetle Spins', reason: 'Cast and retrieve along weed edges', search: 'beetle+spin+perch+fishing' }
    ],
    windPref: 'any', skyPref: 'any'
  },
  {
    id: 'walleye', name: 'Walleye', emoji: 'ğŸ‘ï¸',
    tempMin: 55, tempMax: 68, peakMonths: [4,5,6,9,10,11],
    depthMin: 15, depthMax: 35,
    baits: [
      { name: 'Jig + Minnow', reason: 'The walleye classic â€” bounce the bottom', search: 'walleye+jig+minnow+fishing' },
      { name: 'Worm Harness', reason: 'Slow troll along structure', search: 'worm+harness+walleye+fishing' },
      { name: 'Crankbaits', reason: 'Match the depth with lip size', search: 'walleye+crankbait+fishing+lure' },
      { name: 'Blade Baits', reason: 'Vertical jigging in deeper water', search: 'blade+bait+walleye+fishing' },
      { name: 'Live Leeches', reason: 'Natural presentation on a Lindy rig', search: 'leech+walleye+lindy+rig' }
    ],
    windPref: 'moderate', skyPref: 'overcast'
  }
];

// â”€â”€â”€ DEPTH COLORS (enhanced warmâ†’deep navy) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
const DEPTH_COLORS = [
  { depth: 0,  color: '#62d9c5', label: '0-5 ft' },
  { depth: 5,  color: '#4fc4b7', label: '5-10 ft' },
  { depth: 10, color: '#3aafa9', label: '10-15 ft' },
  { depth: 15, color: '#2b9a96', label: '15-20 ft' },
  { depth: 20, color: '#1f8585', label: '20-25 ft' },
  { depth: 25, color: '#176e77', label: '25-30 ft' },
  { depth: 30, color: '#10566a', label: '30-35 ft' },
  { depth: 35, color: '#0a3f5c', label: '35-40 ft' },
  { depth: 40, color: '#062b4a', label: '40-45 ft' },
  { depth: 45, color: '#031c36', label: '45+ ft' }
];

// â”€â”€â”€ BATHYMETRY GENERATION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function generateBathymetry() {
  const shoreline = [
    [-83.3063, 43.1862], [-83.3058, 43.1868], [-83.3050, 43.1872],
    [-83.3040, 43.1875], [-83.3030, 43.1876], [-83.3020, 43.1875],
    [-83.3010, 43.1873], [-83.3000, 43.1870], [-83.2992, 43.1866],
    [-83.2985, 43.1860], [-83.2981, 43.1853], [-83.2980, 43.1845],
    [-83.2981, 43.1838], [-83.2983, 43.1830], [-83.2987, 43.1823],
    [-83.2992, 43.1818], [-83.2998, 43.1815], [-83.3005, 43.1813],
    [-83.3013, 43.1812], [-83.3022, 43.1813], [-83.3030, 43.1815],
    [-83.3038, 43.1818], [-83.3045, 43.1822], [-83.3050, 43.1826],
    [-83.3054, 43.1830], [-83.3058, 43.1835], [-83.3060, 43.1840],
    [-83.3062, 43.1845], [-83.3063, 43.1850], [-83.3064, 43.1855],
    [-83.3063, 43.1862]
  ];

  function insetPoly(coords, fraction, cx, cy) {
    return coords.map(c => [c[0] + (cx - c[0]) * fraction, c[1] + (cy - c[1]) * fraction]);
  }

  function makeEllipse(cx, cy, rx, ry, n) {
    const pts = [];
    for (let i = 0; i <= n; i++) {
      const a = (i / n) * Math.PI * 2;
      pts.push([cx + rx * Math.cos(a), cy + ry * Math.sin(a)]);
    }
    return pts;
  }

  const cx = -83.3020, cy = 43.1845;
  const nCx = -83.3025, nCy = 43.1860;
  const sCx = -83.3015, sCy = 43.1828;
  const contours = [];

  contours.push({ depth: 0, coords: [shoreline] });
  contours.push({ depth: 5, coords: [insetPoly(shoreline, 0.12, cx, cy)] });
  contours.push({ depth: 10, coords: [insetPoly(shoreline, 0.22, cx, cy)] });
  contours.push({ depth: 15, coords: [insetPoly(shoreline, 0.32, cx, cy)] });
  contours.push({ depth: 20, coords: [
    makeEllipse(nCx, nCy, 0.0025, 0.0012, 24),
    makeEllipse(sCx, sCy, 0.0022, 0.0010, 24)
  ]});
  contours.push({ depth: 25, coords: [
    makeEllipse(nCx, nCy, 0.0018, 0.0009, 20),
    makeEllipse(sCx, sCy, 0.0017, 0.0008, 20)
  ]});
  contours.push({ depth: 30, coords: [
    makeEllipse(nCx, nCy, 0.0012, 0.0006, 16),
    makeEllipse(sCx, sCy, 0.0013, 0.0006, 16)
  ]});
  contours.push({ depth: 35, coords: [
    makeEllipse(nCx, nCy, 0.0007, 0.0004, 12),
    makeEllipse(sCx, sCy, 0.0009, 0.0004, 12)
  ]});
  contours.push({ depth: 40, coords: [makeEllipse(sCx, sCy, 0.0005, 0.0003, 10)] });
  contours.push({ depth: 45, coords: [makeEllipse(sCx, sCy, 0.0002, 0.00015, 8)] });

  return contours;
}

function bathymetryToGeoJSON(contours) {
  const features = [];
  contours.forEach(c => {
    c.coords.forEach(ring => {
      const closed = ring[0][0] === ring[ring.length-1][0] && ring[0][1] === ring[ring.length-1][1]
        ? ring : [...ring, ring[0]];
      features.push({
        type: 'Feature',
        properties: { depth: c.depth, label: DEPTH_COLORS.find(d => d.depth === c.depth)?.label || '' },
        geometry: { type: 'Polygon', coordinates: [closed] }
      });
    });
  });
  return { type: 'FeatureCollection', features };
}

// â”€â”€â”€ WEATHER ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function fetchWeather() {
  const cacheKey = 'bl_weather_v3';
  const cached = localStorage.getItem(cacheKey);
  if (cached) {
    try {
      const { data, ts } = JSON.parse(cached);
      if (Date.now() - ts < CFG.CACHE_TTL && data?.hourly?.pressure_msl) return data;
    } catch(e) {}
  }
  try {
    const url = `https://api.open-meteo.com/v1/forecast?latitude=${CFG.LAT}&longitude=${CFG.LON}&hourly=temperature_2m,relative_humidity_2m,wind_speed_10m,wind_direction_10m,pressure_msl,cloud_cover,precipitation&daily=temperature_2m_max,temperature_2m_min,sunrise,sunset,weather_code&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%2FDetroit&forecast_days=7`;
    const resp = await fetch(url);
    if (!resp.ok) throw new Error('Weather API ' + resp.status);
    const data = await resp.json();
    localStorage.setItem(cacheKey, JSON.stringify({ data, ts: Date.now() }));
    return data;
  } catch(e) {
    console.warn('Weather fetch failed:', e);
    return null;
  }
}

function getCurrentHourIndex(w) {
  if (!w?.hourly?.time) return 0;
  const nowStr = new Date().toISOString().slice(0, 13);
  const idx = w.hourly.time.findIndex(t => t.startsWith(nowStr));
  return idx >= 0 ? idx : 0;
}

function getWindDir(deg) {
  const d = ['N','NNE','NE','ENE','E','ESE','SE','SSE','S','SSW','SW','WSW','W','WNW','NW','NNW'];
  return d[Math.round(deg / 22.5) % 16];
}

function getPressureTrend(w, idx) {
  if (!w?.hourly?.pressure_msl || idx < 3) return 'steady';
  const diff = w.hourly.pressure_msl[idx] - w.hourly.pressure_msl[idx - 3];
  if (diff > 1.5) return 'rising-fast';
  if (diff > 0.5) return 'rising';
  if (diff < -1.5) return 'falling-fast';
  if (diff < -0.5) return 'falling';
  return 'steady';
}

function getWeatherEmoji(code) {
  if (code <= 1) return 'â˜€ï¸';
  if (code <= 3) return 'â›…';
  if (code <= 48) return 'â˜ï¸';
  if (code <= 67) return 'ğŸŒ§ï¸';
  if (code <= 77) return 'â„ï¸';
  if (code <= 82) return 'ğŸŒ¦ï¸';
  if (code <= 86) return 'ğŸŒ¨ï¸';
  return 'â›ˆï¸';
}

// â”€â”€â”€ SOLUNAR ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculateSolunar(date) {
  const lat = CFG.LAT, lon = CFG.LON;
  const sunTimes = SunCalc.getTimes(date, lat, lon);
  const moonTimes = SunCalc.getMoonTimes(date, lat, lon);
  const moonIllum = SunCalc.getMoonIllumination(date);

  let maxAlt = -Infinity, transitTime = date;
  for (let h = 0; h < 24; h += 0.25) {
    const t = new Date(date);
    t.setHours(Math.floor(h), (h % 1) * 60, 0, 0);
    const pos = SunCalc.getMoonPosition(t, lat, lon);
    if (pos.altitude > maxAlt) { maxAlt = pos.altitude; transitTime = new Date(t); }
  }

  const underfootTime = new Date(transitTime.getTime() + 12 * 3600000);
  if (underfootTime.getDate() !== date.getDate()) {
    underfootTime.setTime(underfootTime.getTime() - 24 * 3600000);
  }

  const majors = [], minors = [];
  [transitTime, underfootTime].forEach(t => {
    if (t.getDate() === date.getDate()) {
      majors.push({
        start: new Date(t.getTime() - 3600000),
        end: new Date(t.getTime() + 3600000),
        peak: t, type: t === transitTime ? 'overhead' : 'underfoot'
      });
    }
  });
  if (moonTimes.rise && moonTimes.rise.getDate() === date.getDate()) {
    minors.push({ start: new Date(moonTimes.rise.getTime() - 1800000), end: new Date(moonTimes.rise.getTime() + 1800000), peak: moonTimes.rise, type: 'moonrise' });
  }
  if (moonTimes.set && moonTimes.set.getDate() === date.getDate()) {
    minors.push({ start: new Date(moonTimes.set.getTime() - 1800000), end: new Date(moonTimes.set.getTime() + 1800000), peak: moonTimes.set, type: 'moonset' });
  }

  return {
    sunrise: sunTimes.sunrise, sunset: sunTimes.sunset,
    moonrise: moonTimes.rise, moonset: moonTimes.set,
    moonPhase: moonIllum.phase, moonIllumination: moonIllum.fraction,
    transit: transitTime, underfoot: underfootTime, majors, minors
  };
}

function getSolunarScoreAtTime(solunar, timeMs) {
  for (const m of solunar.majors) {
    if (timeMs >= m.start.getTime() && timeMs <= m.end.getTime()) return 100;
  }
  for (const m of solunar.minors) {
    if (timeMs >= m.start.getTime() && timeMs <= m.end.getTime()) return 70;
  }
  let closest = Infinity;
  [...solunar.majors, ...solunar.minors].forEach(p => {
    const dist = Math.min(Math.abs(timeMs - p.start.getTime()), Math.abs(timeMs - p.end.getTime()));
    if (dist < closest) closest = dist;
  });
  const hoursAway = closest / 3600000;
  if (hoursAway < 1) return 50;
  if (hoursAway < 2) return 40;
  return 30;
}

// â”€â”€â”€ BITE SCORE ALGORITHM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function estimateWaterTemp(w, idx) {
  if (!w?.hourly?.temperature_2m) return getMonthlyWaterTemp();
  const start = Math.max(0, idx - 72);
  const temps = w.hourly.temperature_2m.slice(start, idx + 1);
  const avg = temps.reduce((a, b) => a + b, 0) / temps.length;
  const month = new Date().getMonth() + 1;
  const offset = (month >= 6 && month <= 8) ? -7 : -3;
  return Math.round(avg + offset);
}

function getMonthlyWaterTemp() {
  const temps = [33, 33, 36, 45, 58, 68, 75, 74, 67, 55, 43, 35];
  return temps[new Date().getMonth()];
}

function getSeasonLabel() {
  const m = new Date().getMonth() + 1;
  if (m >= 12 || m <= 2) return 'Winter / Slow & Deep';
  if (m <= 5) return 'Spring / Pre-Spawn';
  if (m <= 8) return 'Summer / Topwater AM/PM';
  return 'Fall / Follow The Bait';
}

function getSeasonalBaitsEnhanced(species, waterTemp, hour) {
  const scored = species.baits.map(bait => {
    let score = 50;
    const b = bait.name.toLowerCase();
    if (waterTemp < 55) {
      if (/jig|minnow|worm|finesse|wax|drop.?shot|ned|leech/.test(b)) score += 30;
      if (/topwater|frog|popper|buzz/.test(b)) score -= 20;
    } else if (waterTemp < 65) {
      if (/crankbait|jerkbait|spinnerbait|spinner|blade/.test(b)) score += 20;
    } else if (waterTemp < 75) {
      if (hour < 8 || hour > 18) {
        if (/topwater|frog|popper|buzz|fly/.test(b)) score += 35;
      } else {
        if (/worm|drop.?shot|jig|deep|plastic/.test(b)) score += 25;
        if (/topwater|frog|popper|buzz/.test(b)) score -= 15;
      }
    } else {
      if (hour < 8 || hour > 18) {
        if (/topwater|frog|popper/.test(b)) score += 25;
      } else {
        if (/worm|drop.?shot|jig|deep/.test(b)) score += 25;
        if (/topwater|frog|popper/.test(b)) score -= 15;
      }
    }
    const month = new Date().getMonth() + 1;
    if (month >= 9 && month <= 11 && /crankbait|swimbait|spoon|blade|spinner/.test(b)) score += 25;
    if (month >= 3 && month <= 5 && /jig|tube|minnow|bobber/.test(b)) score += 20;
    return { ...bait, score };
  });
  scored.sort((a, b) => b.score - a.score);
  return scored.slice(0, 2);
}

function getBaitReason(bait, waterTemp, hour) {
  const b = bait.name.toLowerCase();
  if (waterTemp < 50) return 'Cold water â€” slow presentations';
  if (waterTemp < 60) return 'Pre-spawn â€” work edges slowly';
  if (waterTemp > 75 && (hour < 7 || hour > 19) && /topwater|frog|popper/.test(b)) return 'Low light â€” surface action';
  if (waterTemp > 75 && hour >= 7 && hour <= 19) return 'Hot afternoon â€” go deep';
  return bait.reason;
}

function calculateBiteScore(w, solunar, species, hourIdx) {
  const factors = {};
  const timeMs = w?.hourly?.time?.[hourIdx] ? new Date(w.hourly.time[hourIdx]).getTime() : Date.now();
  factors.solunar = getSolunarScoreAtTime(solunar, timeMs);

  const trend = getPressureTrend(w, hourIdx);
  const pScores = { 'falling': 100, 'falling-fast': 60, 'steady': 55, 'rising': 40, 'rising-fast': 20 };
  factors.pressure = pScores[trend] || 55;

  const phase = solunar.moonPhase;
  factors.moon = Math.round((Math.cos(phase * Math.PI * 2) * 0.5 + 0.5) * 100);

  const waterTemp = estimateWaterTemp(w, hourIdx);
  if (species) {
    const mid = (species.tempMin + species.tempMax) / 2;
    const range = (species.tempMax - species.tempMin) / 2;
    factors.waterTemp = Math.max(0, Math.round(100 - (Math.abs(waterTemp - mid) / range) * 60));
  } else {
    factors.waterTemp = (waterTemp >= 55 && waterTemp <= 75) ? 70 : 40;
  }

  const wind = w?.hourly?.wind_speed_10m?.[hourIdx] || 0;
  if (wind >= 5 && wind <= 15) factors.wind = 85;
  else if (wind < 5) factors.wind = 55;
  else if (wind <= 20) factors.wind = 50;
  else factors.wind = 20;

  const clouds = w?.hourly?.cloud_cover?.[hourIdx] || 50;
  const precip = w?.hourly?.precipitation?.[hourIdx] || 0;
  if (precip > 0.1) factors.sky = 40;
  else if (clouds > 70) factors.sky = 90;
  else if (clouds > 40) factors.sky = 75;
  else factors.sky = 50;

  let score = Math.round(
    factors.solunar * 0.30 + factors.pressure * 0.20 +
    factors.moon * 0.15 + factors.waterTemp * 0.15 +
    factors.wind * 0.10 + factors.sky * 0.10
  );

  if (species) {
    const month = new Date().getMonth() + 1;
    score += species.peakMonths.includes(month) ? 8 : -10;
  }

  return { score: Math.max(0, Math.min(100, score)), factors, waterTemp };
}

// â”€â”€â”€ HOURLY SCORES ENGINE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function calculateHourlyScores(w) {
  if (!w?.hourly?.time) return null;
  const solunar = calculateSolunar(new Date());
  const today = new Date().toISOString().slice(0, 10);
  const startIdx = w.hourly.time.findIndex(t => t.startsWith(today));
  if (startIdx < 0) return null;

  const hours = [];
  for (let h = 0; h < 24; h++) {
    const idx = startIdx + h;
    if (idx >= w.hourly.time.length) break;
    const hourData = { hour: h, idx, species: {} };
    let totalScore = 0;
    SPECIES.forEach(sp => {
      const result = calculateBiteScore(w, solunar, sp, idx);
      hourData.species[sp.id] = result.score;
      totalScore += result.score;
    });
    hourData.avgScore = Math.round(totalScore / SPECIES.length);
    hours.push(hourData);
  }
  return hours;
}

function findBestWindows(scores) {
  if (!scores || scores.length < 2) return [];
  const windows = [];
  let inWindow = false, windowStart = 0;
  const threshold = 65;

  for (let i = 0; i < scores.length; i++) {
    if (scores[i].avgScore >= threshold && !inWindow) {
      inWindow = true;
      windowStart = i;
    } else if ((scores[i].avgScore < threshold || i === scores.length - 1) && inWindow) {
      const end = scores[i].avgScore >= threshold ? i : i - 1;
      if (end - windowStart >= 1) {
        windows.push({ start: windowStart, end: end });
      }
      inWindow = false;
    }
  }
  return windows;
}

// â”€â”€â”€ SCORE HELPERS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function scoreColor(s) {
  if (s >= 86) return '#22c55e';
  if (s >= 71) return '#4ade80';
  if (s >= 51) return '#a3e635';
  if (s >= 31) return '#f59e0b';
  return '#ef4444';
}
function scoreLabel(s) {
  if (s >= 86) return 'Excellent';
  if (s >= 71) return 'Great';
  if (s >= 51) return 'Good';
  if (s >= 31) return 'Fair';
  return 'Poor';
}

// â”€â”€â”€ MAP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initMap() {
  map = new maplibregl.Map({
    container: 'map',
    pixelRatio: Math.min(devicePixelRatio, 2),
    fadeDuration: 150,
    style: {
      version: 8,
      sources: {
        'satellite': TILES.satellite,
        'topo': { ...TILES.topo }
      },
      layers: [
        { id: 'satellite-layer', type: 'raster', source: 'satellite', layout: { visibility: 'visible' } },
        { id: 'topo-layer', type: 'raster', source: 'topo', layout: { visibility: 'none' } }
      ],
      glyphs: 'https://demotiles.maplibre.org/font/{fontstack}/{range}.pbf'
    },
    center: [CFG.LON, CFG.LAT],
    zoom: CFG.ZOOM, pitch: CFG.PITCH, bearing: CFG.BEARING,
    minZoom: CFG.MIN_ZOOM, maxZoom: CFG.MAX_ZOOM,
    attributionControl: false
  });

  map.addControl(new maplibregl.NavigationControl(), 'bottom-right');
  map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');

  map.on('load', () => {
    addBathymetryLayers();
    map.on('click', handleMapClick);
    document.getElementById('splash').classList.add('hidden');
  });
}

function addBathymetryLayers() {
  const geojson = bathymetryToGeoJSON(generateBathymetry());
  map.addSource('bathymetry', { type: 'geojson', data: geojson });

  DEPTH_COLORS.forEach(dc => {
    map.addLayer({
      id: `depth-fill-${dc.depth}`, type: 'fill', source: 'bathymetry',
      filter: ['==', ['get', 'depth'], dc.depth],
      paint: { 'fill-color': dc.color, 'fill-opacity': 0.45 }
    });
  });

  map.addLayer({
    id: 'depth-contours', type: 'line', source: 'bathymetry',
    paint: { 'line-color': 'rgba(255,255,255,0.35)', 'line-width': 1 }
  });

  map.addLayer({
    id: 'depth-labels', type: 'symbol', source: 'bathymetry',
    layout: {
      'text-field': ['get', 'label'], 'text-size': 11,
      'text-font': ['Open Sans Regular'],
      'text-allow-overlap': false, 'text-ignore-placement': false
    },
    paint: {
      'text-color': 'rgba(255,255,255,0.7)',
      'text-halo-color': 'rgba(0,0,0,0.6)', 'text-halo-width': 1.5
    }
  });

  setBathymetryVis(currentView);
}

function setBathymetryVis(view) {
  const show = view === 'depth' || view === 'hybrid';
  const vis = show ? 'visible' : 'none';
  const opacity = view === 'depth' ? 0.8 : 0.45;
  DEPTH_COLORS.forEach(dc => {
    const id = `depth-fill-${dc.depth}`;
    if (map.getLayer(id)) {
      map.setLayoutProperty(id, 'visibility', vis);
      map.setPaintProperty(id, 'fill-opacity', opacity);
    }
  });
  if (map.getLayer('depth-contours')) map.setLayoutProperty('depth-contours', 'visibility', vis);
  if (map.getLayer('depth-labels')) map.setLayoutProperty('depth-labels', 'visibility', vis);
}

function switchView(view) {
  currentView = view;
  const showSat = view === 'satellite' || view === 'hybrid';
  const showTopo = view === 'topo';
  if (map.getLayer('satellite-layer')) map.setLayoutProperty('satellite-layer', 'visibility', showSat ? 'visible' : 'none');
  if (map.getLayer('topo-layer')) map.setLayoutProperty('topo-layer', 'visibility', showTopo ? 'visible' : 'none');
  if (view === 'depth') {
    map.setLayoutProperty('satellite-layer', 'visibility', 'none');
    map.setLayoutProperty('topo-layer', 'visibility', 'none');
  }
  setBathymetryVis(view);
  document.querySelectorAll('#views button').forEach(b => b.classList.toggle('active', b.dataset.view === view));
}

function handleMapClick(e) {
  const tooltip = document.getElementById('depth-tooltip');
  const layers = DEPTH_COLORS.map(dc => `depth-fill-${dc.depth}`).filter(id => map.getLayer(id));
  const features = map.queryRenderedFeatures(e.point, { layers });

  if (!features.length) { tooltip.classList.remove('visible'); return; }

  let maxDepth = 0;
  features.forEach(f => { if (f.properties.depth > maxDepth) maxDepth = f.properties.depth; });

  const zone = maxDepth >= 30 ? 'Deep Basin' : maxDepth >= 15 ? 'Mid-Lake' : 'Shallows';
  const depthSpecies = SPECIES.filter(s => maxDepth >= s.depthMin && maxDepth <= s.depthMax);
  const wt = weatherData ? estimateWaterTemp(weatherData, getCurrentHourIndex(weatherData)) : '--';

  document.getElementById('tt-depth').textContent = `${maxDepth}-${maxDepth + 5} ft`;
  document.getElementById('tt-depth').style.color = scoreColor(100 - maxDepth * 2);
  document.getElementById('tt-zone').textContent = `${zone} Â· ~${wt}Â°F water`;
  document.getElementById('tt-species').innerHTML = depthSpecies.length
    ? depthSpecies.map(s => `<strong>${s.emoji} ${s.name}</strong>`).join(', ')
    : 'No target species at this depth';

  const rect = document.getElementById('map').getBoundingClientRect();
  let x = e.point.x + rect.left + 16, y = e.point.y + rect.top - 20;
  if (x + 220 > window.innerWidth) x = e.point.x + rect.left - 236;
  if (y + 120 > window.innerHeight) y = window.innerHeight - 130;
  if (y < 10) y = 10;
  tooltip.style.left = x + 'px';
  tooltip.style.top = y + 'px';
  tooltip.classList.add('visible');

  setTimeout(() => {
    document.addEventListener('click', function dismiss() {
      tooltip.classList.remove('visible');
      document.removeEventListener('click', dismiss);
    }, { once: true });
  }, 100);
}

// â”€â”€â”€ UI RENDERING â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€

function renderJeff() {
  return `<div class="jeff-banner"><div class="jeff-title">F' YOU JEFF!</div><div class="jeff-sub">Barnes Lake is ours</div></div>`;
}

function renderGauge(score) {
  const color = score !== null ? scoreColor(score) : 'var(--text-muted)';
  const label = score !== null ? scoreLabel(score) : 'Loading weather...';
  const display = score !== null ? score : '--';
  const radius = 70;
  const circ = Math.PI * radius * 1.5;
  const offset = score !== null ? circ * (1 - score / 100) : circ;

  return `
    ${renderJeff()}
    <div class="sec-title">Bite Score</div>
    <div class="gauge-wrap">
      <svg class="gauge-svg" viewBox="0 0 200 150">
        <defs>
          <linearGradient id="gauge-grad" x1="0%" y1="0%" x2="100%" y2="0%">
            <stop offset="0%" stop-color="${'var(--score-poor)'}"/>
            <stop offset="33%" stop-color="${'var(--score-fair)'}"/>
            <stop offset="66%" stop-color="${'var(--teal)'}"/>
            <stop offset="100%" stop-color="${'var(--score-excellent)'}"/>
          </linearGradient>
          <filter id="glow"><feGaussianBlur stdDeviation="4" result="b"/><feMerge><feMergeNode in="b"/><feMergeNode in="SourceGraphic"/></feMerge></filter>
        </defs>
        <path d="M 25 125 A 75 75 0 1 1 175 125" fill="none" stroke="var(--bg-surface)" stroke-width="10" stroke-linecap="round"/>
        <path d="M 25 125 A 75 75 0 1 1 175 125" fill="none" stroke="url(#gauge-grad)" stroke-width="10" stroke-linecap="round"
          stroke-dasharray="${circ}" stroke-dashoffset="${offset}" style="transition: stroke-dashoffset 1.2s var(--spring);" filter="url(#glow)"/>
        <text x="100" y="100" text-anchor="middle" class="gauge-score-text" fill="${color}" filter="url(#glow)">${display}</text>
        <text x="100" y="120" text-anchor="middle" class="gauge-label-text" fill="var(--text-secondary)">${label}</text>
      </svg>
    </div>
  `;
}

function renderTimeline(scores, solunar) {
  if (!scores && !solunar) return '';
  const now = new Date().getHours();
  let html = '<div class="sec-title">Hourly Forecast</div><div class="timeline-scroll" id="timeline-scroll">';

  for (let h = 0; h < 24; h++) {
    const isNow = h === now;
    const hourData = scores ? scores.find(s => s.hour === h) : null;
    const isBest = bestWindows.some(w => h >= w.start && h <= w.end);

    const cls = [isNow ? 'now' : '', isBest ? 'best-window' : ''].filter(Boolean).join(' ');
    const label = h === 0 ? '12a' : h < 12 ? h + 'a' : h === 12 ? '12p' : (h-12) + 'p';

    let scoreHtml = '<span class="timeline-score" style="color:var(--text-muted)">--</span>';
    let barsHtml = '';
    if (hourData) {
      const avg = hourData.avgScore;
      scoreHtml = `<span class="timeline-score" style="color:${scoreColor(avg)}">${avg}</span>`;
      const topSpecies = SPECIES.slice(0, 4);
      barsHtml = '<div class="timeline-bars">' + topSpecies.map(sp => {
        const s = hourData.species[sp.id] || 0;
        return `<div class="timeline-bar-item" style="width:${s}%;background:${scoreColor(s)}"></div>`;
      }).join('') + '</div>';
    }

    let solunarHtml = '<div class="timeline-solunar"></div>';
    if (solunar) {
      const hStart = new Date(); hStart.setHours(h, 0, 0, 0);
      const hEnd = new Date(); hEnd.setHours(h + 1, 0, 0, 0);
      const hMs = hStart.getTime(), hMe = hEnd.getTime();
      let solClass = '';
      for (const m of solunar.majors) {
        if (m.end.getTime() > hMs && m.start.getTime() < hMe) { solClass = 'major'; break; }
      }
      if (!solClass) {
        for (const m of solunar.minors) {
          if (m.end.getTime() > hMs && m.start.getTime() < hMe) { solClass = 'minor'; break; }
        }
      }
      solunarHtml = `<div class="timeline-solunar">${solClass ? `<div class="timeline-solunar-fill ${solClass}"></div>` : ''}</div>`;
    }

    // Sunrise/sunset markers
    let sunMarker = '';
    if (solunar?.sunrise && solunar.sunrise.getHours() === h) sunMarker = '<span class="timeline-sun-marker">ğŸŒ…</span>';
    if (solunar?.sunset && solunar.sunset.getHours() === h) sunMarker = '<span class="timeline-sun-marker">ğŸŒ‡</span>';

    html += `<div class="timeline-col ${cls}" data-hour="${h}" onclick="showTimelinePopup(event, ${h})">
      <span class="timeline-hour">${label}</span>
      ${scoreHtml}
      ${barsHtml}
      ${solunarHtml}
      ${sunMarker}
    </div>`;
  }
  html += '</div>';
  return html;
}

function showTimelinePopup(e, hour) {
  const popup = document.getElementById('timeline-popup');
  const popupHour = document.getElementById('popup-hour');
  const popupSpecies = document.getElementById('popup-species');

  const label = hour === 0 ? '12:00 AM' : hour < 12 ? hour + ':00 AM' : hour === 12 ? '12:00 PM' : (hour-12) + ':00 PM';
  popupHour.textContent = label;

  let speciesHtml = '';
  if (hourlyScores) {
    const hourData = hourlyScores.find(s => s.hour === hour);
    if (hourData) {
      SPECIES.forEach(sp => {
        const s = hourData.species[sp.id] || 0;
        speciesHtml += `<div class="popup-species-row">
          <span class="popup-species-name">${sp.emoji} ${sp.name}</span>
          <span style="color:${scoreColor(s)};font-weight:700">${s}</span>
        </div>`;
      });
    }
  } else {
    speciesHtml = '<div style="color:var(--text-muted)">Weather data loading...</div>';
  }
  popupSpecies.innerHTML = speciesHtml;

  const rect = e.currentTarget.getBoundingClientRect();
  let x = rect.left + rect.width / 2 - 100;
  let y = rect.top - 10;
  if (x < 10) x = 10;
  if (x + 200 > window.innerWidth - 10) x = window.innerWidth - 210;
  if (y < 10) y = rect.bottom + 10;

  popup.style.left = x + 'px';
  popup.style.bottom = (window.innerHeight - y) + 'px';
  popup.style.top = 'auto';
  popup.classList.add('visible');

  setTimeout(() => {
    document.addEventListener('click', function dismiss(ev) {
      if (!popup.contains(ev.target)) {
        popup.classList.remove('visible');
        document.removeEventListener('click', dismiss);
      }
    });
  }, 50);
}

function renderSolunar(solunar) {
  if (!solunar) return '';
  const dayStart = new Date(); dayStart.setHours(0,0,0,0);
  const dayMs = 24 * 3600000;
  const now = Date.now();
  const nowPct = ((now - dayStart.getTime()) / dayMs) * 100;

  function pct(d) { return d ? ((d.getTime() - dayStart.getTime()) / dayMs) * 100 : -1; }
  function fmt(d) { return d ? d.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }) : '--'; }

  let blocks = '';
  solunar.majors.forEach(m => {
    const l = Math.max(0, pct(m.start)), r = Math.min(100, pct(m.end));
    if (r > 0 && l < 100) blocks += `<div class="sol-block major" style="left:${l}%;width:${r-l}%"></div>`;
  });
  solunar.minors.forEach(m => {
    const l = Math.max(0, pct(m.start)), r = Math.min(100, pct(m.end));
    if (r > 0 && l < 100) blocks += `<div class="sol-block minor" style="left:${l}%;width:${r-l}%"></div>`;
  });

  const moonEmoji = solunar.moonPhase < 0.125 ? 'ğŸŒ‘' : solunar.moonPhase < 0.25 ? 'ğŸŒ’' :
    solunar.moonPhase < 0.375 ? 'ğŸŒ“' : solunar.moonPhase < 0.5 ? 'ğŸŒ”' :
    solunar.moonPhase < 0.625 ? 'ğŸŒ•' : solunar.moonPhase < 0.75 ? 'ğŸŒ–' :
    solunar.moonPhase < 0.875 ? 'ğŸŒ—' : 'ğŸŒ˜';

  const events = [
    solunar.sunrise ? `<div class="sol-event">ğŸŒ… Rise ${fmt(solunar.sunrise)}</div>` : '',
    solunar.sunset ? `<div class="sol-event">ğŸŒ‡ Set ${fmt(solunar.sunset)}</div>` : '',
    solunar.moonrise ? `<div class="sol-event">ğŸŒ™ Rise ${fmt(solunar.moonrise)}</div>` : '',
    solunar.moonset ? `<div class="sol-event">ğŸŒ™ Set ${fmt(solunar.moonset)}</div>` : '',
    `<div class="sol-event">${moonEmoji} ${Math.round(solunar.moonIllumination * 100)}%</div>`
  ].filter(Boolean).join('');

  return `
    <div class="sec-title">Solunar Activity</div>
    <div class="solunar-wrap">
      <div class="sol-bar">
        ${blocks}
        <div class="sol-now" style="left:${Math.min(100, Math.max(0, nowPct))}%"></div>
      </div>
      <div class="sol-labels"><span>12a</span><span>6a</span><span>12p</span><span>6p</span><span>12a</span></div>
      <div class="sol-events">${events}</div>
    </div>
  `;
}

function renderFactors(factors) {
  if (!factors) return '';
  const items = [
    { icon: 'ğŸŒ™', name: 'Solunar', val: factors.solunar },
    { icon: 'ğŸ“Š', name: 'Pressure', val: factors.pressure },
    { icon: 'ğŸŒ•', name: 'Moon Phase', val: factors.moon },
    { icon: 'ğŸŒ¡ï¸', name: 'Water Temp', val: factors.waterTemp },
    { icon: 'ğŸ’¨', name: 'Wind', val: factors.wind },
    { icon: 'â˜ï¸', name: 'Conditions', val: factors.sky }
  ];

  return `
    <div class="sec-title">Factor Breakdown</div>
    <div class="factors-list">
      ${items.map(it => `
        <div class="factor-row">
          <span class="factor-icon">${it.icon}</span>
          <span class="factor-name">${it.name}</span>
          <div class="factor-track"><div class="factor-fill" style="width:${it.val}%;background:${scoreColor(it.val)}"></div></div>
          <span class="factor-val" style="color:${scoreColor(it.val)}">${it.val}</span>
        </div>
      `).join('')}
    </div>
  `;
}

function renderSpecies(weather, solunar) {
  const hour = new Date().getHours();
  const waterTemp = weather ? estimateWaterTemp(weather, getCurrentHourIndex(weather)) : getMonthlyWaterTemp();
  const hasWeather = !!weather;
  const hourIdx = hasWeather ? getCurrentHourIndex(weather) : 0;

  const cartSvg = `<svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="9" cy="21" r="1"/><circle cx="20" cy="21" r="1"/><path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"/></svg>`;

  const cards = SPECIES.map(sp => {
    const topBaits = getSeasonalBaitsEnhanced(sp, waterTemp, hour);
    let scoreHtml;
    let sparkHtml = '';

    if (hasWeather) {
      const result = calculateBiteScore(weather, solunar, sp, hourIdx);
      scoreHtml = `
        <div class="sp-score" style="color:${scoreColor(result.score)}">${result.score}</div>
        <div class="sp-status" style="color:${scoreColor(result.score)}">${scoreLabel(result.score)}</div>`;

      // Sparkline
      if (hourlyScores) {
        const points = hourlyScores.map((h, i) => {
          const s = h.species[sp.id] || 0;
          const x = (i / 23) * 100;
          const y = 30 - (s / 100) * 28;
          return `${x},${y}`;
        }).join(' ');
        sparkHtml = `<div class="sp-sparkline"><svg viewBox="0 0 100 32" preserveAspectRatio="none">
          <polyline points="${points}" fill="none" stroke="${scoreColor(result.score)}" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" opacity="0.6"/>
        </svg></div>`;
      }
    } else {
      const month = new Date().getMonth() + 1;
      const inSeason = sp.peakMonths.includes(month);
      scoreHtml = `
        <div class="sp-score" style="color:var(--text-muted)">--</div>
        <div class="sp-status" style="color:${inSeason ? 'var(--teal)' : 'var(--text-muted)'}">${inSeason ? 'In Season' : 'Off Peak'}</div>`;
    }

    const baitsHtml = topBaits.map(bait => {
      const reason = hasWeather ? getBaitReason(bait, waterTemp, hour) : bait.reason;
      const amazonUrl = `https://www.amazon.com/s?k=${encodeURIComponent(bait.search || bait.name + ' fishing lure')}`;
      return `<div class="sp-bait">
        <div style="flex:1">
          <div class="sp-bait-name">${bait.name}</div>
          <div class="sp-bait-reason">${reason}</div>
        </div>
        <a class="sp-bait-link" href="${amazonUrl}" target="_blank" rel="noopener" aria-label="Shop ${bait.name} on Amazon">${cartSvg}</a>
      </div>`;
    }).join('');

    return `<div class="sp-card">
      <div class="sp-top">
        <div class="sp-info">
          <span class="sp-emoji">${sp.emoji}</span>
          <div>
            <div class="sp-name">${sp.name}</div>
            <div class="sp-depth">${sp.depthMin}-${sp.depthMax} ft Â· ${sp.tempMin}-${sp.tempMax}Â°F</div>
          </div>
        </div>
        <div class="sp-score-wrap">${scoreHtml}</div>
      </div>
      ${sparkHtml}
      <div class="sp-baits">${baitsHtml}</div>
    </div>`;
  }).join('');

  return `<div class="sec-title">Species Forecast â€” ${getSeasonLabel()}</div><div class="species-grid">${cards}</div>`;
}

function renderOutlook(weather, solunar) {
  if (!weather?.daily) return '';
  const cards = weather.daily.time.map((dateStr, i) => {
    const date = new Date(dateStr + 'T12:00:00');
    const dayName = i === 0 ? 'Today' : date.toLocaleDateString('en-US', { weekday: 'short' });
    const emoji = getWeatherEmoji(weather.daily.weather_code[i]);
    const high = Math.round(weather.daily.temperature_2m_max[i]);
    const low = Math.round(weather.daily.temperature_2m_min[i]);

    const daySolunar = calculateSolunar(date);
    const noonIdx = Math.min(i * 24 + 12, weather.hourly.time.length - 1);
    const result = calculateBiteScore(weather, daySolunar, null, noonIdx);

    let bestSp = SPECIES[0], bestSc = 0;
    SPECIES.forEach(sp => {
      const r = calculateBiteScore(weather, daySolunar, sp, noonIdx);
      if (r.score > bestSc) { bestSc = r.score; bestSp = sp; }
    });

    return `<div class="outlook-card">
      <div class="outlook-day ${i === 0 ? 'today' : ''}">${dayName}</div>
      <div class="outlook-icon">${emoji}</div>
      <div class="outlook-temps"><span class="hi">${high}Â°</span> / ${low}Â°</div>
      <div class="outlook-mini" style="color:${scoreColor(result.score)}">${result.score}</div>
      <div class="outlook-sp">${bestSp.emoji} ${bestSp.name.split(' ')[0]}</div>
    </div>`;
  }).join('');

  return `<div class="sec-title">7-Day Outlook</div><div class="outlook-scroll">${cards}</div>`;
}

function updateConditionsBar(w) {
  if (!w?.hourly) return;
  const idx = getCurrentHourIndex(w);
  document.getElementById('cond-temp').textContent = Math.round(w.hourly.temperature_2m[idx]);
  document.getElementById('cond-wind').textContent = Math.round(w.hourly.wind_speed_10m[idx]);
  document.getElementById('cond-wind-dir').textContent = getWindDir(w.hourly.wind_direction_10m[idx]);
  document.getElementById('cond-pressure').textContent = Math.round(w.hourly.pressure_msl[idx]);

  const trend = getPressureTrend(w, idx);
  const arrow = document.getElementById('pressure-arrow');
  if (trend.includes('rising')) { arrow.textContent = 'â†‘'; arrow.className = 'trend-arrow rising'; }
  else if (trend.includes('falling')) { arrow.textContent = 'â†“'; arrow.className = 'trend-arrow falling'; }
  else { arrow.textContent = 'â†’'; arrow.className = 'trend-arrow steady'; }
}

function updatePeekBar(score, solunar) {
  const ps = document.getElementById('peek-score');
  const pn = document.getElementById('peek-next');
  if (ps) {
    ps.textContent = score !== null ? score : '--';
    ps.style.color = score !== null ? scoreColor(score) : 'var(--text-muted)';
  }
  if (pn && solunar) {
    const now = Date.now();
    let nextEv = null, nextType = '';
    [...solunar.majors, ...solunar.minors].forEach(p => {
      if (p.start.getTime() > now && (!nextEv || p.start.getTime() < nextEv.getTime())) {
        nextEv = p.start;
        nextType = solunar.majors.includes(p) ? 'Major' : 'Minor';
      }
    });
    pn.innerHTML = nextEv
      ? `Next ${nextType}<br><strong>${nextEv.toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' })}</strong>`
      : `Check tomorrow's<br><strong>solunar times</strong>`;
  }
}

// â”€â”€â”€ MAIN RENDER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function refreshUI() {
  const solunar = calculateSolunar(new Date());
  const isDesktop = window.innerWidth >= 1024;

  // Compute hourly data
  if (weatherData) {
    hourlyScores = calculateHourlyScores(weatherData);
    bestWindows = findBestWindows(hourlyScores);
  }

  let gaugeHtml, timelineHtml, solunarHtml, factorsHtml, speciesHtml, outlookHtml;

  if (weatherData) {
    const idx = getCurrentHourIndex(weatherData);
    const result = calculateBiteScore(weatherData, solunar, null, idx);
    updateConditionsBar(weatherData);
    gaugeHtml = renderGauge(result.score);
    factorsHtml = renderFactors(result.factors);
    outlookHtml = renderOutlook(weatherData, solunar);
    updatePeekBar(result.score, solunar);
  } else {
    gaugeHtml = renderGauge(null);
    factorsHtml = '';
    outlookHtml = '';
    updatePeekBar(null, solunar);
  }

  timelineHtml = renderTimeline(hourlyScores, solunar);
  solunarHtml = renderSolunar(solunar);
  speciesHtml = renderSpecies(weatherData, solunar);

  const allHtml = gaugeHtml + timelineHtml + solunarHtml + factorsHtml + speciesHtml + outlookHtml;

  if (isDesktop) {
    document.getElementById('sidebar').innerHTML = allHtml;
  } else {
    document.getElementById('sheet-content').innerHTML = allHtml;
  }

  // Auto-scroll timeline to current hour
  requestAnimationFrame(() => {
    const scroll = document.getElementById('timeline-scroll');
    if (scroll) {
      const nowCol = scroll.querySelector('.timeline-col.now');
      if (nowCol) {
        nowCol.scrollIntoView({ inline: 'center', behavior: 'smooth' });
      }
    }
  });
}

// â”€â”€â”€ BOTTOM SHEET â€” iOS SPRING PHYSICS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initBottomSheet() {
  const sheet = document.getElementById('sheet');
  const backdrop = document.getElementById('sheet-backdrop');
  if (!sheet || window.innerWidth >= 1024) return;

  const handle = sheet.querySelector('.sheet-handle');
  const content = sheet.querySelector('.sheet-content');
  const safeBottom = parseInt(getComputedStyle(document.documentElement).getPropertyValue('--safe-bottom')) || 0;
  const peekH = 160 + safeBottom;
  const halfH = window.innerHeight * 0.5;
  const fullH = window.innerHeight * 0.92;

  let startY = 0, startTranslate = 0, currentTranslate = 0;
  let isDragging = false;
  let touchHistory = [];

  function setHeight(h, animate) {
    const ty = window.innerHeight - h;
    if (animate) sheet.style.transition = `transform 0.45s var(--spring)`;
    else sheet.style.transition = 'none';
    sheet.style.transform = `translateY(${ty}px)`;
    currentTranslate = ty;

    // Backdrop opacity based on position
    const progress = Math.max(0, Math.min(1, (h - peekH) / (fullH - peekH)));
    backdrop.style.opacity = progress * 0.4;
    backdrop.className = progress > 0.01 ? 'active' : '';

    // Enable/disable content scrolling
    if (h >= fullH - 20) {
      content.style.overflowY = 'auto';
    } else {
      content.style.overflowY = 'hidden';
      content.scrollTop = 0;
    }
  }

  sheet.style.height = `${fullH}px`;
  setHeight(peekH, false);

  function onStart(clientY) {
    // Only drag when scrollTop is 0 or we're on the handle
    isDragging = true;
    startY = clientY;
    startTranslate = currentTranslate;
    touchHistory = [{ y: clientY, t: Date.now() }];
    sheet.style.transition = 'none';
  }

  function onMove(clientY) {
    if (!isDragging) return;
    touchHistory.push({ y: clientY, t: Date.now() });
    if (touchHistory.length > 5) touchHistory.shift();

    const dy = clientY - startY;
    const minTy = window.innerHeight - fullH;
    const maxTy = window.innerHeight - peekH;
    let newTy = startTranslate + dy;

    // Rubberband overdrag (30% logarithmic resistance)
    if (newTy < minTy) {
      const over = minTy - newTy;
      newTy = minTy - Math.log(1 + over * 0.3) * 20;
    }
    if (newTy > maxTy) {
      const over = newTy - maxTy;
      newTy = maxTy + Math.log(1 + over * 0.3) * 20;
    }

    sheet.style.transform = `translateY(${newTy}px)`;
    currentTranslate = newTy;

    const h = window.innerHeight - newTy;
    const progress = Math.max(0, Math.min(1, (h - peekH) / (fullH - peekH)));
    backdrop.style.opacity = progress * 0.4;
    backdrop.className = progress > 0.01 ? 'active' : '';
  }

  function onEnd() {
    if (!isDragging) return;
    isDragging = false;

    // Compute velocity from last touches
    let velocity = 0;
    if (touchHistory.length >= 2) {
      const last = touchHistory[touchHistory.length - 1];
      const prev = touchHistory[Math.max(0, touchHistory.length - 3)];
      const dt = last.t - prev.t;
      if (dt > 0) velocity = (last.y - prev.y) / dt; // px/ms
    }

    const currentH = window.innerHeight - currentTranslate;
    const snapPoints = [peekH, halfH, fullH];
    let target;

    // Velocity-based snapping
    if (Math.abs(velocity) > 0.5) {
      if (velocity > 0) {
        // Swiping down
        target = snapPoints.filter(s => s < currentH).pop() || peekH;
      } else {
        // Swiping up
        target = snapPoints.find(s => s > currentH) || fullH;
      }
    } else {
      // Nearest snap
      target = snapPoints[0];
      let minDist = Math.abs(currentH - target);
      snapPoints.forEach(sp => {
        const d = Math.abs(currentH - sp);
        if (d < minDist) { minDist = d; target = sp; }
      });
    }

    setHeight(target, true);
  }

  // Touch events on handle
  handle.addEventListener('touchstart', e => onStart(e.touches[0].clientY), { passive: true });
  handle.addEventListener('touchmove', e => onMove(e.touches[0].clientY), { passive: true });
  handle.addEventListener('touchend', onEnd, { passive: true });

  // Scroll handoff: drag only when scrollTop=0 and dragging down
  let contentDragging = false;
  content.addEventListener('touchstart', e => {
    if (content.scrollTop <= 0) {
      contentDragging = true;
      onStart(e.touches[0].clientY);
    }
  }, { passive: true });
  content.addEventListener('touchmove', e => {
    if (contentDragging && content.scrollTop <= 0) {
      const dy = e.touches[0].clientY - startY;
      if (dy > 0) { onMove(e.touches[0].clientY); }
      else { contentDragging = false; isDragging = false; }
    }
  }, { passive: true });
  content.addEventListener('touchend', () => {
    if (contentDragging) { onEnd(); contentDragging = false; }
  }, { passive: true });

  // Mouse for desktop testing
  handle.addEventListener('mousedown', e => onStart(e.clientY));
  document.addEventListener('mousemove', e => { if (isDragging) onMove(e.clientY); });
  document.addEventListener('mouseup', onEnd);

  // Backdrop click â†’ collapse to peek
  backdrop.addEventListener('click', () => setHeight(peekH, true));
}

// â”€â”€â”€ SETTINGS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initSettings() {
  const btn = document.getElementById('settings-btn');
  const panel = document.getElementById('settings-panel');
  const backdrop = document.getElementById('settings-backdrop');
  const closeBtn = panel.querySelector('.settings-close');

  function open() { panel.classList.add('open'); backdrop.classList.add('open'); }
  function close() { panel.classList.remove('open'); backdrop.classList.remove('open'); }

  btn.addEventListener('click', open);
  backdrop.addEventListener('click', close);
  closeBtn.addEventListener('click', close);

  // Restore settings
  const tempToggle = document.getElementById('toggle-temp');
  const windToggle = document.getElementById('toggle-wind');
  const wakeToggle = document.getElementById('toggle-wake');

  if (settings.tempUnit !== 'F') tempToggle.classList.remove('on');
  if (settings.windUnit !== 'mph') windToggle.classList.remove('on');
  if (!settings.wakeLock) wakeToggle.classList.remove('on');

  tempToggle.addEventListener('click', () => {
    tempToggle.classList.toggle('on');
    settings.tempUnit = tempToggle.classList.contains('on') ? 'F' : 'C';
    saveSettings(); refreshUI();
  });
  windToggle.addEventListener('click', () => {
    windToggle.classList.toggle('on');
    settings.windUnit = windToggle.classList.contains('on') ? 'mph' : 'km/h';
    saveSettings(); refreshUI();
  });
  wakeToggle.addEventListener('click', () => {
    wakeToggle.classList.toggle('on');
    settings.wakeLock = wakeToggle.classList.contains('on');
    saveSettings();
    if (settings.wakeLock) requestWakeLock(); else releaseWakeLock();
  });
}

// â”€â”€â”€ VIEW SWITCHER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function initViewSwitcher() {
  document.querySelectorAll('#views button').forEach(btn => {
    btn.addEventListener('click', () => switchView(btn.dataset.view));
  });
}

// â”€â”€â”€ SCREEN WAKE LOCK â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function requestWakeLock() {
  if (!('wakeLock' in navigator)) return;
  try {
    wakeLock = await navigator.wakeLock.request('screen');
    wakeLock.addEventListener('release', () => { wakeLock = null; });
  } catch(e) { /* permission denied or not supported */ }
}
function releaseWakeLock() {
  if (wakeLock) { wakeLock.release(); wakeLock = null; }
}
document.addEventListener('visibilitychange', () => {
  if (document.visibilityState === 'visible' && settings.wakeLock) requestWakeLock();
});

// â”€â”€â”€ INIT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function init() {
  initMap();
  initViewSwitcher();
  initSettings();
  initBottomSheet();

  // Render immediately (solunar-only, no weather needed)
  refreshUI();

  // Wake lock
  if (settings.wakeLock) requestWakeLock();

  // Fetch weather async, update on arrival
  weatherData = await fetchWeather();
  refreshUI();

  // Auto-refresh every 30min
  setInterval(async () => {
    weatherData = await fetchWeather();
    refreshUI();
  }, CFG.CACHE_TTL);

  // Resize handler
  let resizeTimer;
  window.addEventListener('resize', () => {
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(() => { refreshUI(); initBottomSheet(); }, 250);
  });
}

// Service worker
if ('serviceWorker' in navigator) {
  navigator.serviceWorker.register('sw.js').catch(() => {});
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
