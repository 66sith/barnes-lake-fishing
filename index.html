<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover, maximum-scale=1, user-scalable=no">
    <title>FishCast Pro — AI Fishing Intelligence</title>
    <meta name="description" content="AI-powered fishing forecasts, species targeting, solunar activity, and catch logging. The smartest fishing companion for serious anglers.">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="FishCast Pro">
    <link rel="apple-touch-icon" href="icons/apple-touch-icon.png">
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#060e1a" media="(prefers-color-scheme: dark)">
    <meta name="theme-color" content="#060e1a" media="(prefers-color-scheme: light)">
    <link rel="icon" type="image/svg+xml" href="icons/favicon.svg">
    <link href="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700;800;900&display=swap" rel="stylesheet">
<style>
/* ═══════════════════════════════════════════════════════════════════════════════
   FISHCAST PRO — DESIGN SYSTEM
   Premium fishing intelligence platform
   ═══════════════════════════════════════════════════════════════════════════════ */

:root {
    --bg-deep: #060e1a;
    --bg-mid: #0b1829;
    --bg-surface: #111f33;
    --bg-card: rgba(14,28,48,0.78);
    --glass: rgba(15,31,53,0.72);
    --glass-heavy: rgba(10,22,40,0.92);
    --gold: #d4a843;
    --gold-light: #e8c76a;
    --gold-dark: #b08930;
    --gold-glow: rgba(212,168,67,0.15);
    --teal: #00d4aa;
    --teal-light: #33e0be;
    --teal-dim: rgba(0,212,170,0.12);
    --cyan: #00bfff;
    --score-excellent: #22c55e;
    --score-great: #4ade80;
    --score-good: #a3e635;
    --score-fair: #f59e0b;
    --score-poor: #ef4444;
    --text-primary: #f0f4f8;
    --text-secondary: #8899aa;
    --text-muted: #556677;
    --border: rgba(255,255,255,0.06);
    --border-light: rgba(255,255,255,0.10);
    --shadow: 0 8px 32px rgba(0,0,0,0.5);
    --radius: 16px;
    --radius-sm: 10px;
    --radius-xs: 6px;
    --font-display: 'Playfair Display', Georgia, 'Times New Roman', serif;
    --font-body: -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', system-ui, sans-serif;
    --spring: cubic-bezier(0.34, 1.56, 0.64, 1);
    --ease: cubic-bezier(0.2, 0, 0, 1);
    --safe-top: env(safe-area-inset-top, 0px);
    --safe-bottom: env(safe-area-inset-bottom, 0px);
    --safe-left: env(safe-area-inset-left, 0px);
    --safe-right: env(safe-area-inset-right, 0px);
}

*, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }

html {
    height: 100%;
    -webkit-text-size-adjust: 100%;
    -webkit-font-smoothing: antialiased;
    -moz-osx-font-smoothing: grayscale;
}

body {
    height: 100%;
    font-family: var(--font-body);
    background: linear-gradient(180deg, var(--bg-deep) 0%, var(--bg-mid) 30%, var(--bg-surface) 100%);
    color: var(--text-primary);
    overflow: hidden;
    overscroll-behavior: none;
    -webkit-tap-highlight-color: transparent;
    touch-action: manipulation;
}

#app {
    display: flex;
    flex-direction: column;
    height: 100dvh;
    max-width: 100vw;
    overflow: hidden;
    position: relative;
}

/* ─── Loading Screen ───────────────────────────────────────────── */
#splash {
    position: fixed; inset: 0; z-index: 9999;
    background: var(--bg-deep);
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    transition: opacity 0.5s var(--ease), visibility 0.5s;
}
#splash.hidden { opacity: 0; visibility: hidden; pointer-events: none; }
#splash .logo-mark {
    width: 72px; height: 72px; border-radius: 18px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 12px 40px rgba(212,168,67,0.3);
    animation: splashPulse 1.5s ease infinite;
}
#splash .logo-mark svg { width: 36px; height: 36px; fill: none; stroke: var(--bg-deep); stroke-width: 2.5; }
#splash h1 {
    font-family: var(--font-display); font-size: 22px; font-weight: 700;
    letter-spacing: 4px; color: var(--gold); margin-top: 20px;
}
#splash p { font-size: 11px; color: var(--text-muted); letter-spacing: 2px; margin-top: 6px; }
@keyframes splashPulse {
    0%, 100% { transform: scale(1); }
    50% { transform: scale(1.05); }
}

/* ─── Header ───────────────────────────────────────────────────── */
#header {
    display: flex; align-items: center; justify-content: space-between;
    padding: 8px 16px; padding-top: calc(8px + var(--safe-top));
    background: rgba(6,14,26,0.92); backdrop-filter: blur(24px); -webkit-backdrop-filter: blur(24px);
    border-bottom: 1px solid var(--border); z-index: 100; flex-shrink: 0;
}
.header-brand { display: flex; align-items: center; gap: 10px; text-decoration: none; }
.header-logo {
    width: 36px; height: 36px; border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    display: flex; align-items: center; justify-content: center;
}
.header-logo svg { width: 18px; height: 18px; fill: none; stroke: var(--bg-deep); stroke-width: 2.5; }
.header-title { font-family: var(--font-display); font-size: 13px; font-weight: 700; letter-spacing: 3px; color: var(--gold); line-height: 1; }
.header-sub { font-size: 9px; font-weight: 600; letter-spacing: 2px; color: var(--text-muted); margin-top: 1px; }

.lake-selector-btn {
    display: flex; align-items: center; gap: 6px;
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    border-radius: var(--radius-sm); padding: 8px 14px; cursor: pointer; color: var(--text-primary);
    font-family: var(--font-body); font-size: 13px; font-weight: 600; transition: all 0.2s;
}
.lake-selector-btn:active { transform: scale(0.97); background: rgba(255,255,255,0.08); }
.lake-selector-btn svg:first-child { color: var(--teal); }

.header-actions { display: flex; gap: 6px; }
.header-btn {
    width: 36px; height: 36px; border-radius: var(--radius-sm);
    background: rgba(255,255,255,0.05); border: 1px solid var(--border);
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-secondary); transition: all 0.2s;
}
.header-btn:active { transform: scale(0.92); }

/* ─── Content Area ─────────────────────────────────────────────── */
#content {
    flex: 1; overflow-y: auto; overflow-x: hidden;
    -webkit-overflow-scrolling: touch; scroll-behavior: smooth;
    padding-bottom: 8px;
}
.screen { display: none; padding: 0 12px 20px; }
.screen.active { display: block; animation: fadeIn 0.3s var(--ease); }
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: translateY(0); } }

/* ─── Glass Card ───────────────────────────────────────────────── */
.glass {
    background: var(--glass); backdrop-filter: blur(40px); -webkit-backdrop-filter: blur(40px);
    border: 1px solid var(--border); border-radius: var(--radius);
    transition: transform 0.2s var(--ease), box-shadow 0.2s;
}
.glass:active { transform: scale(0.985); }

/* ─── Score Gauge ──────────────────────────────────────────────── */
.score-gauge { position: relative; }
.score-gauge svg { transform: rotate(-90deg); }
.score-gauge .value {
    position: absolute; inset: 0; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
}
.score-gauge .number {
    font-family: var(--font-display); font-weight: 800; line-height: 1;
}
.score-gauge .label {
    font-size: 9px; font-weight: 600; color: var(--text-secondary);
    letter-spacing: 2px; margin-top: 2px;
}

/* ─── Factor Bars ──────────────────────────────────────────────── */
.factor-row { display: flex; align-items: center; gap: 10px; padding: 7px 0; }
.factor-icon { font-size: 16px; width: 22px; text-align: center; flex-shrink: 0; }
.factor-label { font-size: 12px; color: var(--text-secondary); width: 80px; flex-shrink: 0; }
.factor-track {
    flex: 1; height: 6px; background: rgba(255,255,255,0.06);
    border-radius: 3px; overflow: hidden;
}
.factor-fill {
    height: 100%; border-radius: 3px;
    transition: width 1s var(--spring);
}
.factor-value {
    font-family: var(--font-display); font-size: 13px; font-weight: 700;
    width: 32px; text-align: right; flex-shrink: 0;
}

/* ─── Section Headers ──────────────────────────────────────────── */
.section-title {
    font-size: 11px; font-weight: 700; letter-spacing: 2px; color: var(--gold);
    text-transform: uppercase;
}

/* ─── Hourly Timeline ──────────────────────────────────────────── */
.hourly-scroll {
    display: flex; gap: 2px; overflow-x: auto; padding-bottom: 4px;
    scrollbar-width: none; -ms-overflow-style: none;
}
.hourly-scroll::-webkit-scrollbar { display: none; }
.hourly-cell {
    display: flex; flex-direction: column; align-items: center; gap: 4px;
    min-width: 48px; padding: 8px 4px; border-radius: var(--radius-sm);
    border: 1px solid transparent; transition: all 0.2s;
}
.hourly-cell.now { border-color: rgba(255,255,255,0.1); }
.hourly-bar-container {
    width: 32px; height: 44px; border-radius: var(--radius-xs);
    display: flex; align-items: flex-end; justify-content: center; overflow: hidden;
}
.hourly-bar {
    width: 100%; border-radius: 4px 4px 0 0;
    transition: height 0.8s var(--spring);
}

/* ─── Solunar Periods ──────────────────────────────────────────── */
.solunar-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; }
.solunar-period {
    padding: 10px 12px; border-radius: var(--radius-sm); border: 1px solid var(--border);
    background: rgba(255,255,255,0.02);
}
.solunar-period.major {
    background: var(--gold-glow); border-color: rgba(212,168,67,0.3);
}
.solunar-type {
    font-size: 9px; font-weight: 700; letter-spacing: 1.5px; margin-bottom: 4px;
}
.solunar-time { font-size: 13px; font-weight: 600; color: var(--text-primary); }
.solunar-chips { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 12px; }
.solunar-chip {
    display: flex; align-items: center; gap: 5px; padding: 5px 10px;
    border-radius: 20px; background: rgba(255,255,255,0.04); border: 1px solid var(--border);
    font-size: 11px; color: var(--text-secondary);
}
.solunar-chip .icon { font-size: 13px; }

/* ─── Weekly Forecast ──────────────────────────────────────────── */
.weekly-row { display: flex; justify-content: space-between; }
.weekly-day {
    display: flex; flex-direction: column; align-items: center; gap: 6px;
    padding: 8px 2px; border-radius: var(--radius-sm); flex: 1;
}
.weekly-day.today { background: rgba(255,255,255,0.03); }
.weekly-day .name { font-size: 11px; color: var(--text-muted); }
.weekly-day.today .name { font-weight: 700; color: var(--text-primary); }
.weekly-day .emoji { font-size: 18px; }
.weekly-day .temps { font-size: 11px; color: var(--text-secondary); }
.weekly-score {
    width: 30px; height: 30px; border-radius: 15px; border-width: 2px; border-style: solid;
    display: flex; align-items: center; justify-content: center;
    font-size: 11px; font-weight: 700;
}
.weekly-day .precip { font-size: 9px; color: var(--cyan); }

/* ─── Species Cards ────────────────────────────────────────────── */
.species-card { display: flex; align-items: flex-start; gap: 14px; }
.species-avatar {
    width: 52px; height: 52px; border-radius: 14px;
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; flex-shrink: 0;
}
.species-name { font-family: var(--font-display); font-size: 16px; font-weight: 700; }
.species-score-badge {
    font-size: 13px; font-weight: 800; padding: 2px 8px; border-radius: 6px;
}
.species-desc { font-size: 12px; color: var(--text-secondary); margin-top: 6px; line-height: 1.5; }
.species-tags { display: flex; gap: 8px; margin-top: 10px; flex-wrap: wrap; }
.species-tag {
    display: flex; align-items: center; gap: 4px; padding: 4px 10px;
    border-radius: 8px; font-size: 11px;
}
.species-tag.depth { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text-secondary); }
.species-tag.bait { background: var(--gold-glow); border: 1px solid rgba(212,168,67,0.2); color: var(--gold-light); }

/* ─── Catch Log ────────────────────────────────────────────────── */
.stats-grid { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 8px; }
.stat-card { text-align: center; }
.stat-card svg { margin: 0 auto 6px; display: block; }
.stat-value { font-family: var(--font-display); font-size: 18px; font-weight: 800; }
.stat-label { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; margin-top: 2px; }
.catch-entry { padding: 14px 0; border-bottom: 1px solid var(--border); }
.catch-entry:last-child { border-bottom: none; }
.catch-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 8px; }
.catch-species { font-family: var(--font-display); font-size: 15px; font-weight: 700; }
.catch-meta { font-size: 12px; color: var(--text-secondary); margin-top: 2px; }
.catch-badges { display: flex; gap: 8px; }
.catch-badge {
    padding: 4px 10px; border-radius: 8px; font-size: 13px; font-weight: 700;
}
.catch-badge.weight { background: var(--teal-dim); border: 1px solid rgba(0,212,170,0.3); color: var(--teal); }
.catch-badge.length { background: rgba(255,255,255,0.04); border: 1px solid var(--border); color: var(--text-secondary); font-weight: 600; }
.catch-details { display: flex; gap: 8px; flex-wrap: wrap; }
.catch-detail { display: flex; align-items: center; gap: 4px; font-size: 11px; }
.catch-notes { font-size: 12px; color: var(--text-secondary); margin-top: 8px; font-style: italic; line-height: 1.4; }
.log-btn {
    display: flex; align-items: center; gap: 6px; padding: 10px 16px;
    border-radius: 12px; background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    border: none; cursor: pointer; color: var(--bg-deep); font-weight: 700; font-size: 12px;
    font-family: var(--font-body); transition: transform 0.2s;
}
.log-btn:active { transform: scale(0.95); }

/* ─── Map ──────────────────────────────────────────────────────── */
#map-container { height: 360px; border-radius: var(--radius); overflow: hidden; position: relative; }
#maplibre { width: 100%; height: 100%; }
.map-controls {
    position: absolute; top: 12px; right: 12px; display: flex; flex-direction: column; gap: 4px; z-index: 10;
}
.map-mode-btn {
    padding: 6px 10px; font-size: 10px; font-weight: 700; letter-spacing: 1px;
    border-radius: var(--radius-xs); cursor: pointer; transition: all 0.2s;
    background: rgba(0,0,0,0.6); border: 1px solid var(--border); color: var(--text-muted);
    font-family: var(--font-body);
}
.map-mode-btn.active { background: var(--teal-dim); border-color: rgba(0,212,170,0.5); color: var(--teal); }
.map-legend {
    position: absolute; bottom: 12px; left: 12px; display: flex; gap: 8px; flex-wrap: wrap; z-index: 10;
}
.legend-item {
    display: flex; align-items: center; gap: 4px; padding: 4px 8px; border-radius: var(--radius-xs);
    background: rgba(0,0,0,0.6); backdrop-filter: blur(10px); font-size: 10px; color: var(--text-secondary);
}
.legend-dot { width: 8px; height: 8px; border-radius: 4px; }
.lake-info-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.lake-info-item {
    padding: 10px; border-radius: 8px; background: rgba(255,255,255,0.03);
}
.lake-info-label { font-size: 10px; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 4px; }
.lake-info-value { font-size: 13px; font-weight: 600; }
.species-chip-list { display: flex; flex-wrap: wrap; gap: 6px; }
.species-chip {
    padding: 6px 12px; border-radius: 8px; background: rgba(255,255,255,0.04);
    border: 1px solid var(--border); font-size: 12px; color: var(--text-secondary);
}

/* ─── Premium Screen ───────────────────────────────────────────── */
.premium-hero { text-align: center; padding: 32px 16px 16px; }
.premium-icon {
    width: 72px; height: 72px; border-radius: 20px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    display: flex; align-items: center; justify-content: center;
    margin: 0 auto 16px; box-shadow: 0 8px 32px rgba(212,168,67,0.4);
}
.premium-icon svg { width: 34px; height: 34px; stroke: var(--bg-deep); fill: none; stroke-width: 2; }
.premium-title { font-family: var(--font-display); font-size: 28px; font-weight: 800; margin-bottom: 4px; }
.premium-subtitle { font-size: 14px; color: var(--text-secondary); line-height: 1.5; }

.pricing-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.pricing-card { padding: 20px 16px; text-align: center; position: relative; }
.pricing-card.popular { border: 2px solid var(--gold); }
.pricing-save {
    position: absolute; top: -10px; left: 50%; transform: translateX(-50%);
    padding: 3px 10px; border-radius: 12px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    font-size: 10px; font-weight: 800; color: var(--bg-deep); letter-spacing: 1px; white-space: nowrap;
}
.pricing-period { font-size: 12px; color: var(--text-muted); letter-spacing: 1px; margin-bottom: 8px; }
.pricing-price { font-family: var(--font-display); font-size: 32px; font-weight: 800; }
.pricing-sub { font-size: 11px; color: var(--text-muted); }

.feature-row {
    display: flex; gap: 12px; padding: 12px 0; border-bottom: 1px solid var(--border);
}
.feature-row:last-child { border-bottom: none; }
.feature-icon-wrap {
    width: 36px; height: 36px; border-radius: var(--radius-sm);
    background: var(--gold-glow); display: flex; align-items: center; justify-content: center; flex-shrink: 0;
}
.feature-icon-wrap svg { width: 16px; height: 16px; stroke: var(--gold); fill: none; }
.feature-title { font-size: 14px; font-weight: 600; }
.feature-desc { font-size: 12px; color: var(--text-muted); margin-top: 2px; line-height: 1.4; }

.cta-btn {
    width: 100%; padding: 16px; border-radius: 14px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    border: none; cursor: pointer; font-size: 16px; font-weight: 800;
    color: var(--bg-deep); letter-spacing: 1px; font-family: var(--font-display);
    box-shadow: 0 8px 32px rgba(212,168,67,0.4); transition: transform 0.2s;
}
.cta-btn:active { transform: scale(0.97); }
.cta-sub { text-align: center; font-size: 11px; color: var(--text-muted); margin-top: 8px; }

/* ─── Premium Badge ────────────────────────────────────────────── */
.pro-badge {
    display: inline-flex; align-items: center; gap: 4px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: var(--bg-deep); font-size: 10px; font-weight: 700;
    padding: 2px 8px; border-radius: 20px; letter-spacing: 1px;
}
.pro-badge svg { width: 10px; height: 10px; stroke: var(--bg-deep); fill: none; stroke-width: 2.5; }

/* ─── Peak Window Banner ───────────────────────────────────────── */
.peak-banner {
    margin-top: 16px; padding: 10px 14px; border-radius: var(--radius-sm);
    background: linear-gradient(135deg, var(--gold-glow), rgba(212,168,67,0.05));
    border: 1px solid rgba(212,168,67,0.3); display: flex; align-items: center; gap: 10px;
}
.peak-banner svg { color: var(--gold); flex-shrink: 0; }
.peak-label { font-size: 12px; font-weight: 700; color: var(--gold); }
.peak-time { font-size: 12px; color: var(--text-secondary); margin-left: 8px; }

/* ─── Quick Species Row ────────────────────────────────────────── */
.quick-species-row {
    display: flex; align-items: center; gap: 12px; padding: 10px 0;
    border-bottom: 1px solid var(--border);
}
.quick-species-row:last-child { border-bottom: none; }
.quick-species-emoji { font-size: 24px; }
.quick-species-info { flex: 1; }
.quick-species-name { font-size: 13px; font-weight: 600; }
.quick-species-meta { font-size: 11px; color: var(--text-muted); }
.quick-species-score {
    width: 40px; height: 40px; border-radius: 20px; border-width: 2px; border-style: solid;
    display: flex; align-items: center; justify-content: center;
    font-family: var(--font-display); font-size: 14px; font-weight: 800;
}

/* ─── Bottom Navigation ────────────────────────────────────────── */
#bottom-nav {
    display: flex; justify-content: space-around;
    padding: 6px 0; padding-bottom: max(6px, var(--safe-bottom));
    background: rgba(6,14,26,0.95); backdrop-filter: blur(20px); -webkit-backdrop-filter: blur(20px);
    border-top: 1px solid var(--border); z-index: 100; flex-shrink: 0;
}
.nav-item {
    display: flex; flex-direction: column; align-items: center; gap: 1px;
    background: none; border: none; cursor: pointer; padding: 4px 12px;
    color: var(--text-muted); transition: all 0.2s; -webkit-tap-highlight-color: transparent;
    font-family: var(--font-body);
}
.nav-item.active { color: var(--gold); }
.nav-item svg { width: 20px; height: 20px; transition: transform 0.2s var(--spring); }
.nav-item.active svg { transform: scale(1.1); }
.nav-item .nav-label { font-size: 10px; font-weight: 500; letter-spacing: 0.5px; }
.nav-item.active .nav-label { font-weight: 700; }
.nav-dot {
    width: 4px; height: 4px; border-radius: 2px; background: var(--gold);
    margin-top: 1px; opacity: 0; transition: opacity 0.2s;
}
.nav-item.active .nav-dot { opacity: 1; }

/* ─── Lake Selector Modal ──────────────────────────────────────── */
#lake-modal {
    position: fixed; inset: 0; z-index: 200;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
    display: none; flex-direction: column; justify-content: flex-end;
}
#lake-modal.open { display: flex; animation: fadeIn 0.2s var(--ease); }
.lake-sheet {
    background: var(--bg-mid); border-radius: 20px 20px 0 0;
    padding: 20px 16px; padding-bottom: max(20px, var(--safe-bottom));
    max-height: 70vh; overflow-y: auto; border: 1px solid var(--border); border-bottom: none;
    animation: slideUp 0.3s var(--spring);
}
@keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
.lake-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px; }
.lake-sheet-title { font-family: var(--font-display); font-size: 18px; font-weight: 700; }
.lake-close-btn {
    width: 32px; height: 32px; border-radius: 16px; background: rgba(255,255,255,0.05);
    border: 1px solid var(--border); display: flex; align-items: center; justify-content: center;
    cursor: pointer; color: var(--text-muted);
}
.lake-search {
    display: flex; align-items: center; gap: 8px; padding: 10px 14px; border-radius: 12px;
    background: rgba(255,255,255,0.04); border: 1px solid var(--border); margin-bottom: 16px;
}
.lake-search span { font-size: 13px; color: var(--text-muted); flex: 1; }
.lake-list-label { font-size: 10px; font-weight: 700; letter-spacing: 2px; color: var(--text-muted); margin-bottom: 8px; }
.lake-option {
    display: flex; align-items: center; gap: 12px; width: 100%; padding: 12px;
    border-radius: 12px; background: transparent; border: 1px solid transparent;
    cursor: pointer; margin-bottom: 4px; text-align: left; color: var(--text-primary);
    font-family: var(--font-body); transition: all 0.15s;
}
.lake-option:active { transform: scale(0.98); }
.lake-option.selected { background: var(--teal-dim); border-color: rgba(0,212,170,0.3); }
.lake-option-icon {
    width: 40px; height: 40px; border-radius: var(--radius-sm); background: rgba(0,212,170,0.1);
    display: flex; align-items: center; justify-content: center;
}
.lake-option-icon svg { width: 18px; height: 18px; stroke: var(--teal); fill: none; }
.lake-option-name { font-size: 14px; font-weight: 600; }
.lake-option-meta { font-size: 11px; color: var(--text-muted); }
.lake-selected-dot { width: 8px; height: 8px; border-radius: 4px; background: var(--teal); margin-left: auto; }
.add-lake-btn {
    display: flex; align-items: center; justify-content: center; gap: 8px; width: 100%;
    padding: 14px; border-radius: 12px; background: rgba(255,255,255,0.04);
    border: 1px dashed var(--border); cursor: pointer; margin-top: 8px;
    color: var(--text-muted); font-size: 13px; font-family: var(--font-body);
}

/* ─── Ambient Glow ─────────────────────────────────────────────── */
.ambient-gold, .ambient-teal {
    position: fixed; pointer-events: none; border-radius: 50%; z-index: 0;
}
.ambient-gold {
    top: -100px; right: -100px; width: 300px; height: 300px;
    background: radial-gradient(circle, rgba(212,168,67,0.06) 0%, transparent 70%);
}
.ambient-teal {
    bottom: -150px; left: -100px; width: 400px; height: 400px;
    background: radial-gradient(circle, rgba(0,212,170,0.04) 0%, transparent 70%);
}

/* ─── Responsive Desktop ───────────────────────────────────────── */
@media (min-width: 768px) {
    #app { max-width: 480px; margin: 0 auto; box-shadow: 0 0 60px rgba(0,0,0,0.5); }
    body { display: flex; justify-content: center; align-items: center; }
}

/* ─── Utility ──────────────────────────────────────────────────── */
.flex { display: flex; }
.flex-col { flex-direction: column; }
.items-center { align-items: center; }
.justify-between { justify-content: space-between; }
.gap-4 { gap: 4px; }
.gap-8 { gap: 8px; }
.gap-12 { gap: 12px; }
.gap-16 { gap: 16px; }
.mt-12 { margin-top: 12px; }
.mt-16 { margin-top: 16px; }
.mb-12 { margin-bottom: 12px; }
.mb-14 { margin-bottom: 14px; }
.p-16 { padding: 16px; }
.p-20 { padding: 20px; }

/* ═══════════════════════════════════════════════════════════════════════════════
   TOKEN GATE — Partner Evaluation Environment
   ═══════════════════════════════════════════════════════════════════════════════ */
#eval-gate {
    position: fixed; inset: 0; z-index: 99999;
    background: var(--bg-deep);
    display: flex; flex-direction: column; align-items: center; justify-content: center;
    padding: 32px 24px;
    transition: opacity 0.6s var(--ease), visibility 0.6s;
}
#eval-gate.dismissed { opacity: 0; visibility: hidden; pointer-events: none; }

.gate-ambient-1 {
    position: absolute; top: -20%; right: -10%; width: 500px; height: 500px;
    background: radial-gradient(circle, rgba(212,168,67,0.04) 0%, transparent 65%);
    pointer-events: none;
}
.gate-ambient-2 {
    position: absolute; bottom: -20%; left: -10%; width: 600px; height: 600px;
    background: radial-gradient(circle, rgba(0,212,170,0.03) 0%, transparent 60%);
    pointer-events: none;
}

.gate-logo {
    width: 88px; height: 88px; border-radius: 22px;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    display: flex; align-items: center; justify-content: center;
    box-shadow: 0 16px 48px rgba(212,168,67,0.25), 0 0 0 1px rgba(212,168,67,0.15);
    margin-bottom: 32px;
    animation: gatePulse 3s ease infinite;
}
.gate-logo svg { width: 44px; height: 44px; fill: none; stroke: var(--bg-deep); stroke-width: 2.2; }
@keyframes gatePulse {
    0%, 100% { box-shadow: 0 16px 48px rgba(212,168,67,0.25), 0 0 0 1px rgba(212,168,67,0.15); }
    50% { box-shadow: 0 20px 60px rgba(212,168,67,0.35), 0 0 0 1px rgba(212,168,67,0.25); }
}

.gate-divider {
    width: 40px; height: 1px;
    background: linear-gradient(90deg, transparent, var(--gold), transparent);
    margin-bottom: 24px;
}

.gate-label {
    font-size: 10px; font-weight: 700; letter-spacing: 3.5px;
    color: var(--text-muted); text-transform: uppercase; margin-bottom: 6px;
}
.gate-title {
    font-family: var(--font-display); font-size: 18px; font-weight: 600;
    color: var(--text-primary); letter-spacing: 0.5px; margin-bottom: 40px;
    text-align: center; line-height: 1.4;
}

.gate-input-group {
    width: 100%; max-width: 340px;
    display: flex; flex-direction: column; gap: 12px;
    margin-bottom: 16px;
}
.gate-input-label {
    font-size: 10px; font-weight: 600; letter-spacing: 2px;
    color: var(--text-muted); text-transform: uppercase;
}
.gate-input {
    width: 100%; padding: 14px 18px;
    background: rgba(255,255,255,0.04);
    border: 1px solid var(--border-light);
    border-radius: 12px; color: var(--text-primary);
    font-family: 'SF Mono', 'Fira Code', 'Consolas', monospace;
    font-size: 15px; font-weight: 600; letter-spacing: 2px;
    text-align: center; text-transform: uppercase;
    outline: none; transition: all 0.3s var(--ease);
    caret-color: var(--gold);
}
.gate-input::placeholder {
    color: var(--text-muted); letter-spacing: 2px;
    font-weight: 400; text-transform: none;
}
.gate-input:focus {
    border-color: var(--gold); background: rgba(212,168,67,0.04);
    box-shadow: 0 0 0 3px rgba(212,168,67,0.08);
}
.gate-input.error {
    border-color: var(--score-poor);
    box-shadow: 0 0 0 3px rgba(239,68,68,0.1);
    animation: gateShake 0.4s ease;
}
@keyframes gateShake {
    0%, 100% { transform: translateX(0); }
    20%, 60% { transform: translateX(-6px); }
    40%, 80% { transform: translateX(6px); }
}

.gate-submit {
    width: 100%; max-width: 340px; padding: 14px;
    border-radius: 12px; border: none; cursor: pointer;
    background: linear-gradient(135deg, var(--gold), var(--gold-dark));
    color: var(--bg-deep); font-family: var(--font-body);
    font-size: 13px; font-weight: 700; letter-spacing: 1.5px;
    text-transform: uppercase; transition: all 0.2s;
    box-shadow: 0 4px 20px rgba(212,168,67,0.25);
}
.gate-submit:active { transform: scale(0.97); }
.gate-submit:disabled {
    opacity: 0.4; cursor: not-allowed; transform: none;
}

.gate-error-msg {
    font-size: 12px; color: var(--score-poor); margin-top: 8px;
    text-align: center; min-height: 18px;
    transition: opacity 0.2s;
}

.gate-footer {
    position: absolute; bottom: 32px; left: 0; right: 0;
    text-align: center;
}
.gate-footer-line {
    font-size: 9px; font-weight: 600; letter-spacing: 2.5px;
    color: var(--text-muted); text-transform: uppercase;
}
.gate-footer-brand {
    font-size: 10px; font-weight: 700; letter-spacing: 3px;
    color: rgba(212,168,67,0.5); margin-top: 4px;
}

.gate-confidential {
    font-size: 9px; color: rgba(255,255,255,0.12);
    letter-spacing: 1px; margin-top: 20px;
    text-align: center; max-width: 300px; line-height: 1.5;
}

/* ─── Catch Modal ─────────────────────────────────────────────── */
.catch-modal {
    position: fixed; inset: 0; z-index: 250;
    background: rgba(0,0,0,0.7); backdrop-filter: blur(10px);
    display: none; flex-direction: column; justify-content: flex-end;
}
.catch-modal.open { display: flex; animation: fadeIn 0.2s var(--ease); }
.catch-sheet {
    background: var(--bg-mid); border-radius: 20px 20px 0 0;
    padding: 24px 20px 40px; max-height: 85vh; overflow-y: auto;
}
.catch-sheet-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
.catch-sheet-header h3 { font-family: var(--font-display); font-size: 1.3rem; color: var(--text-primary); margin: 0; }
.catch-sheet-header button { background: none; border: none; color: var(--text-muted); font-size: 1.3rem; cursor: pointer; }
.catch-sheet-body { display: flex; flex-direction: column; gap: 16px; }
.catch-field { display: flex; flex-direction: column; gap: 6px; position: relative; }
.catch-field label { font-size: 11px; font-weight: 700; letter-spacing: 0.1em; text-transform: uppercase; color: var(--gold); }
.catch-field input, .catch-field select, .catch-field textarea {
    background: var(--bg-surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 12px 14px; color: var(--text-primary); font-size: 15px; font-family: inherit;
    outline: none; transition: border-color 0.2s;
}
.catch-field input:focus, .catch-field select:focus, .catch-field textarea:focus { border-color: var(--gold); }
.catch-field select { appearance: none; cursor: pointer; }
.catch-field select option { background: var(--bg-mid); }
.catch-field textarea { resize: none; }
.catch-unit { position: absolute; right: 14px; bottom: 13px; font-size: 13px; color: var(--text-muted); pointer-events: none; }
.catch-field-row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
.catch-save-btn {
    background: linear-gradient(135deg, var(--gold), var(--gold-dark)); border: none; border-radius: 12px;
    padding: 14px; color: var(--bg-deep); font-size: 15px; font-weight: 700; cursor: pointer;
    letter-spacing: 0.03em; margin-top: 8px; font-family: var(--font-body);
}
.catch-delete-btn {
    background: none; border: none; color: var(--score-poor); font-size: 11px;
    cursor: pointer; padding: 4px 8px; border-radius: 6px; font-family: var(--font-body);
    border: 1px solid rgba(239,68,68,0.2);
}

/* ─── Settings Panel ──────────────────────────────────────────── */
.settings-panel {
    position: fixed; inset: 0; z-index: 300;
    background: var(--bg-deep);
    transform: translateX(100%);
    transition: transform 0.3s var(--ease);
    display: flex; flex-direction: column;
    overflow-y: auto;
}
.settings-panel.open { transform: translateX(0); }
.settings-header {
    display: flex; justify-content: space-between; align-items: center;
    padding: 20px 20px 16px; border-bottom: 1px solid var(--border);
}
.settings-header h2 { font-family: var(--font-display); font-size: 1.4rem; color: var(--text-primary); margin: 0; }
.settings-close { background: none; border: none; color: var(--text-muted); font-size: 1.5rem; cursor: pointer; padding: 8px; }
.settings-body { padding: 16px 20px; flex: 1; }
.settings-group { margin-bottom: 24px; }
.settings-group-title { font-size: 11px; font-weight: 700; letter-spacing: 0.12em; text-transform: uppercase; color: var(--gold); margin-bottom: 12px; }
.settings-row { display: flex; justify-content: space-between; align-items: center; padding: 12px 0; border-bottom: 1px solid rgba(255,255,255,0.04); color: var(--text-secondary); font-size: 14px; }
.settings-toggle-group { display: flex; gap: 4px; }
.settings-opt { padding: 6px 14px; border-radius: 8px; border: 1px solid var(--border); background: transparent; color: var(--text-muted); font-size: 13px; cursor: pointer; transition: all 0.2s; font-family: var(--font-body); }
.settings-opt.active { background: rgba(212,168,67,0.15); border-color: var(--gold); color: var(--gold); }
.switch { position: relative; width: 44px; height: 24px; flex-shrink: 0; }
.switch input { opacity: 0; width: 0; height: 0; }
.slider { position: absolute; inset: 0; background: rgba(255,255,255,0.1); border-radius: 24px; cursor: pointer; transition: 0.3s; }
.slider:before { content: ''; position: absolute; height: 18px; width: 18px; left: 3px; bottom: 3px; background: white; border-radius: 50%; transition: 0.3s; }
.switch input:checked + .slider { background: var(--gold); }
.switch input:checked + .slider:before { transform: translateX(20px); }
.settings-danger-btn { padding: 6px 16px; border-radius: 8px; border: 1px solid rgba(239,68,68,0.3); background: rgba(239,68,68,0.1); color: #ef4444; font-size: 13px; cursor: pointer; font-family: var(--font-body); }

/* Session timer bar */
#session-timer {
    position: fixed; top: 0; left: 0; right: 0; height: 3px;
    z-index: 99998; display: none;
}
#session-timer .timer-bar {
    height: 100%; background: linear-gradient(90deg, var(--gold), var(--gold-light));
    transition: width 1s linear;
    box-shadow: 0 0 8px rgba(212,168,67,0.4);
}
#session-timer .timer-label {
    position: absolute; top: 6px; right: 12px;
    font-size: 10px; font-weight: 600; letter-spacing: 1px;
    color: var(--gold); font-family: 'SF Mono', 'Fira Code', monospace;
    background: rgba(6,14,26,0.9); padding: 3px 8px; border-radius: 4px;
    border: 1px solid rgba(212,168,67,0.2);
}
</style>
</head>
<body>

<!-- ═══ Evaluation Gate ═══ -->
<div id="eval-gate">
    <div class="gate-ambient-1"></div>
    <div class="gate-ambient-2"></div>

    <div class="gate-logo">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3" stroke-linecap="round"/><path d="M7 12c0-2.5 2-5 5-5s5 2.5 5 5" stroke-linecap="round"/><circle cx="9" cy="11" r="0.5" fill="currentColor"/><path d="M14 13c2 1 4 3 7 3" stroke-linecap="round"/><path d="M15 11c2-1 4-2 6.5-1.5" stroke-linecap="round"/></svg>
    </div>

    <div class="gate-divider"></div>

    <div class="gate-label">Restricted Access</div>
    <div class="gate-title">Partner Evaluation Environment</div>

    <div class="gate-input-group">
        <div class="gate-input-label">Evaluation Key</div>
        <input type="text" id="gate-token" class="gate-input" placeholder="FC-XXXX-XXXX-XXXX"
            autocomplete="off" autocorrect="off" autocapitalize="characters" spellcheck="false"
            maxlength="19">
    </div>

    <button id="gate-submit" class="gate-submit" onclick="validateToken()" disabled>Authenticate</button>
    <div id="gate-error" class="gate-error-msg"></div>

    <div class="gate-confidential">
        This evaluation environment contains proprietary technology under active development.
        Unauthorized access or distribution is prohibited.
    </div>

    <div class="gate-footer">
        <div class="gate-footer-line">Developed by</div>
        <div class="gate-footer-brand">WASUBI LABS</div>
    </div>
</div>

<!-- Session Timer -->
<div id="session-timer">
    <div class="timer-bar" style="width:100%"></div>
    <div class="timer-label">60:00</div>
</div>

<!-- ═══ Splash Screen ═══ -->
<div id="splash">
    <div class="logo-mark">
        <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3" stroke-linecap="round"/><path d="M7 12c0-2.5 2-5 5-5s5 2.5 5 5" stroke-linecap="round"/><circle cx="9" cy="11" r="0.5" fill="currentColor"/><path d="M14 13c2 1 4 3 7 3" stroke-linecap="round"/><path d="M15 11c2-1 4-2 6.5-1.5" stroke-linecap="round"/></svg>
    </div>
    <h1>FISHCAST</h1>
    <p>PRO</p>
</div>

<!-- ═══ App Shell ═══ -->
<div id="app">
    <div class="ambient-gold"></div>
    <div class="ambient-teal"></div>

    <!-- Header -->
    <div id="header">
        <div class="header-brand">
            <div class="header-logo">
                <svg viewBox="0 0 24 24"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3" stroke-linecap="round"/><path d="M7 12c0-2.5 2-5 5-5s5 2.5 5 5" stroke-linecap="round"/><path d="M14 13c2 1 4 3 7 3" stroke-linecap="round"/></svg>
            </div>
            <div>
                <div class="header-title">FISHCAST</div>
                <div class="header-sub">PRO</div>
            </div>
        </div>
        <button class="lake-selector-btn" id="lake-selector-btn" onclick="openLakeModal()">
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 10c0 7-9 13-9 13s-9-6-9-13a9 9 0 0118 0z"/><circle cx="12" cy="10" r="3"/></svg>
            <span id="header-lake-name">Barnes Lake</span>
            <svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><path d="M6 9l6 6 6-6"/></svg>
        </button>
        <div class="header-actions">
            <button class="header-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 01-3.46 0"/></svg></button>
            <button class="header-btn" onclick="openSettings()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 00.33 1.82l.06.06a2 2 0 010 2.83 2 2 0 01-2.83 0l-.06-.06a1.65 1.65 0 00-1.82-.33 1.65 1.65 0 00-1 1.51V21a2 2 0 01-2 2 2 2 0 01-2-2v-.09A1.65 1.65 0 009 19.4a1.65 1.65 0 00-1.82.33l-.06.06a2 2 0 01-2.83 0 2 2 0 010-2.83l.06-.06A1.65 1.65 0 004.68 15a1.65 1.65 0 00-1.51-1H3a2 2 0 01-2-2 2 2 0 012-2h.09A1.65 1.65 0 004.6 9a1.65 1.65 0 00-.33-1.82l-.06-.06a2 2 0 010-2.83 2 2 0 012.83 0l.06.06A1.65 1.65 0 009 4.68a1.65 1.65 0 001-1.51V3a2 2 0 012-2 2 2 0 012 2v.09a1.65 1.65 0 001 1.51 1.65 1.65 0 001.82-.33l.06-.06a2 2 0 012.83 0 2 2 0 010 2.83l-.06.06a1.65 1.65 0 00-.33 1.82V9a1.65 1.65 0 001.51 1H21a2 2 0 012 2 2 2 0 01-2 2h-.09a1.65 1.65 0 00-1.51 1z"/></svg></button>
        </div>
    </div>

    <!-- Content -->
    <div id="content">
        <!-- FORECAST SCREEN -->
        <div id="screen-home" class="screen active"></div>
        <!-- SPECIES SCREEN -->
        <div id="screen-species" class="screen"></div>
        <!-- CATCH LOG SCREEN -->
        <div id="screen-log" class="screen"></div>
        <!-- MAP SCREEN -->
        <div id="screen-map" class="screen"></div>
        <!-- PREMIUM SCREEN -->
        <div id="screen-premium" class="screen"></div>
    </div>

    <!-- Bottom Nav -->
    <div id="bottom-nav">
        <button class="nav-item active" data-screen="home" onclick="switchScreen('home')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z"/></svg>
            <span class="nav-label">Forecast</span><div class="nav-dot"></div>
        </button>
        <button class="nav-item" data-screen="species" onclick="switchScreen('species')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3"/><path d="M14 13c2 1 4 3 7 3"/><path d="M15 11c2-1 4-2 6.5-1.5"/></svg>
            <span class="nav-label">Species</span><div class="nav-dot"></div>
        </button>
        <button class="nav-item" data-screen="log" onclick="switchScreen('log')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M4 19.5A2.5 2.5 0 016.5 17H20"/><path d="M6.5 2H20v20H6.5A2.5 2.5 0 014 19.5v-15A2.5 2.5 0 016.5 2z"/></svg>
            <span class="nav-label">Catch Log</span><div class="nav-dot"></div>
        </button>
        <button class="nav-item" data-screen="map" onclick="switchScreen('map')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><circle cx="12" cy="12" r="10"/><path d="M16.24 7.76a6 6 0 010 8.49m-8.48-.01a6 6 0 010-8.49"/><line x1="12" y1="2" x2="12" y2="6"/><line x1="12" y1="18" x2="12" y2="22"/><line x1="2" y1="12" x2="6" y2="12"/><line x1="18" y1="12" x2="22" y2="12"/></svg>
            <span class="nav-label">Map</span><div class="nav-dot"></div>
        </button>
        <button class="nav-item" data-screen="premium" onclick="switchScreen('premium')">
            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5"><path d="M2 4l3 12h14l3-12-5.5 5L12 2l-4.5 5L2 4z"/><path d="M5 16l-1 4h16l-1-4"/></svg>
            <span class="nav-label">Pro</span><div class="nav-dot"></div>
        </button>
    </div>

    <!-- Lake Selector Modal -->
    <div id="lake-modal">
        <div class="lake-sheet" id="lake-sheet"></div>
    </div>

    <!-- Log Catch Modal -->
    <div id="catch-modal" class="catch-modal">
        <div class="catch-sheet">
            <div class="catch-sheet-header">
                <h3>Log a Catch</h3>
                <button onclick="closeCatchModal()">✕</button>
            </div>
            <div class="catch-sheet-body">
                <div class="catch-field">
                    <label>Species</label>
                    <select id="catch-species">
                        <option value="">Select species...</option>
                    </select>
                </div>
                <div class="catch-field-row">
                    <div class="catch-field">
                        <label>Weight</label>
                        <input type="number" id="catch-weight" placeholder="0.0" step="0.1" min="0">
                        <span class="catch-unit">lbs</span>
                    </div>
                    <div class="catch-field">
                        <label>Length</label>
                        <input type="number" id="catch-length" placeholder="0" step="0.5" min="0">
                        <span class="catch-unit">in</span>
                    </div>
                </div>
                <div class="catch-field">
                    <label>Bait / Lure</label>
                    <input type="text" id="catch-bait" placeholder="What did you use?">
                </div>
                <div class="catch-field">
                    <label>Depth</label>
                    <input type="number" id="catch-depth" placeholder="0" step="1" min="0">
                    <span class="catch-unit">ft</span>
                </div>
                <div class="catch-field">
                    <label>Notes</label>
                    <textarea id="catch-notes" placeholder="Location, conditions, technique..." rows="2"></textarea>
                </div>
                <button class="catch-save-btn" onclick="saveCatch()">Save Catch</button>
            </div>
        </div>
    </div>

    <!-- Settings Panel -->
    <div id="settings-panel" class="settings-panel">
        <div class="settings-header">
            <h2>Settings</h2>
            <button class="settings-close" onclick="closeSettings()">✕</button>
        </div>
        <div class="settings-body">
            <div class="settings-group">
                <div class="settings-group-title">Units</div>
                <div class="settings-row">
                    <span>Temperature</span>
                    <div class="settings-toggle-group">
                        <button class="settings-opt active" onclick="setSetting('tempUnit','F',this)">°F</button>
                        <button class="settings-opt" onclick="setSetting('tempUnit','C',this)">°C</button>
                    </div>
                </div>
                <div class="settings-row">
                    <span>Weight</span>
                    <div class="settings-toggle-group">
                        <button class="settings-opt active" onclick="setSetting('weightUnit','lbs',this)">lbs</button>
                        <button class="settings-opt" onclick="setSetting('weightUnit','kg',this)">kg</button>
                    </div>
                </div>
                <div class="settings-row">
                    <span>Length</span>
                    <div class="settings-toggle-group">
                        <button class="settings-opt active" onclick="setSetting('lengthUnit','in',this)">in</button>
                        <button class="settings-opt" onclick="setSetting('lengthUnit','cm',this)">cm</button>
                    </div>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Notifications</div>
                <div class="settings-row">
                    <span>Peak Window Alerts</span>
                    <label class="switch"><input type="checkbox" id="setting-peak-alerts" checked onchange="toggleSetting('peakAlerts',this.checked)"><span class="slider"></span></label>
                </div>
                <div class="settings-row">
                    <span>Solunar Reminders</span>
                    <label class="switch"><input type="checkbox" id="setting-solunar" checked onchange="toggleSetting('solunarReminders',this.checked)"><span class="slider"></span></label>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">Data</div>
                <div class="settings-row">
                    <span>Clear Catch Log</span>
                    <button class="settings-danger-btn" onclick="if(confirm('Delete all catch entries?')){localStorage.removeItem('fc_catches');renderCatchLog();closeSettings();}">Clear</button>
                </div>
            </div>
            <div class="settings-group">
                <div class="settings-group-title">About</div>
                <div class="settings-row" style="flex-direction:column;align-items:flex-start;gap:4px">
                    <span style="color:var(--text-primary)">FishCast Pro v1.0.0</span>
                    <span style="font-size:11px;color:var(--text-muted)">Developed by Wasubi Labs</span>
                    <span style="font-size:11px;color:var(--text-muted)">AI-powered fishing intelligence</span>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/maplibre-gl@4.7.1/dist/maplibre-gl.js"></script>
<script src="https://cdn.jsdelivr.net/npm/suncalc@1.9.0/suncalc.min.js"></script>
<script>
/* ═══════════════════════════════════════════════════════════════════════════════
   FISHCAST PRO — ENGINE
   ═══════════════════════════════════════════════════════════════════════════════ */
'use strict';

// ─── State ────────────────────────────────────────────────────────────────────
const LAKES = [
    { id:1, name:"Barnes Lake", location:"Lapeer County, MI", acres:149, maxDepth:45, lat:43.1845, lng:-83.3025, species:["Largemouth Bass","Smallmouth Bass","Northern Pike","Crappie","Bluegill","Perch","Walleye"], saved:true },
    { id:2, name:"Lake Nepessing", location:"Lapeer County, MI", acres:360, maxDepth:62, lat:42.94, lng:-83.34, species:["Largemouth Bass","Walleye","Bluegill","Crappie","Pike"], saved:true },
    { id:3, name:"Lake Orion", location:"Oakland County, MI", acres:514, maxDepth:75, lat:42.78, lng:-83.24, species:["Largemouth Bass","Smallmouth Bass","Walleye","Pike","Panfish"], saved:false },
];

const SPECIES_DB = [
    { name:"Largemouth Bass", emoji:"🐟", depth:"8-15ft", technique:"Slow roll spinnerbaits near submerged timber", baits:["Spinnerbait","Jig & Trailer"], temp:"Prefers 65-80°F", pattern:"Holding near deep structure", premium:false },
    { name:"Northern Pike", emoji:"🐊", depth:"6-12ft", technique:"Dead bait or large swimbaits worked slowly", baits:["Sucker Minnow","Swimbait"], temp:"Active in 55-75°F", pattern:"Cruising weed edges", premium:false },
    { name:"Crappie", emoji:"🐠", depth:"15-25ft", technique:"Vertical jig with small plastics over deep brush", baits:["1/16oz Jig","Small Minnow"], temp:"Stacking in 50-65°F", pattern:"Schooled on deep structure", premium:false },
    { name:"Bluegill", emoji:"🟡", depth:"10-18ft", technique:"Small jigs under slip float near weed edges", baits:["Wax Worm","Micro Jig"], temp:"Moderate in 45-65°F", pattern:"Scattered along weed lines", premium:true },
    { name:"Walleye", emoji:"👁️", depth:"18-30ft", technique:"Jigging spoons at dusk over main lake basin", baits:["Jigging Rap","Live Minnow"], temp:"Peak at 55-68°F", pattern:"Moving shallow at dusk/dawn", premium:true },
    { name:"Perch", emoji:"🟠", depth:"12-22ft", technique:"Small minnows on drop shot near sandy flats", baits:["Minnow","Perch Eye"], temp:"Active 50-70°F", pattern:"Roaming in schools on flats", premium:true },
    { name:"Smallmouth Bass", emoji:"🟤", depth:"10-20ft", technique:"Drop shot with finesse worms on rocky points", baits:["Ned Rig","Tube Jig"], temp:"Best 60-75°F", pattern:"Holding on rocky structure", premium:true },
];

const CATCH_LOG = [
    { species:"Largemouth Bass", weight:"4.2 lbs", length:'18"', lake:"Barnes Lake", date:"Feb 20, 2026", time:"7:15 AM", bait:"Spinnerbait", notes:"Caught near the fallen oak on the south shore", photo:true },
    { species:"Crappie", weight:"1.1 lbs", length:'11"', lake:"Barnes Lake", date:"Feb 18, 2026", time:"5:45 PM", bait:"Small Minnow", notes:"Found a school at 20ft over the brush pile", photo:false },
    { species:"Northern Pike", weight:"8.7 lbs", length:'28"', lake:"Lake Nepessing", date:"Feb 15, 2026", time:"11:30 AM", bait:"Sucker Minnow", notes:"Hit right at the weed edge. Incredible fight!", photo:true },
    { species:"Bluegill", weight:"0.6 lbs", length:'8"', lake:"Barnes Lake", date:"Feb 12, 2026", time:"3:20 PM", bait:"Wax Worm", notes:"Nice slab through the ice", photo:false },
];

let state = {
    currentLake: LAKES[0],
    currentScreen: 'home',
    weather: null,
    hourly: [],
    solunar: null,
    weeklyForecast: [],
    speciesScores: [],
    mapInstance: null,
    loaded: false,
};

// ─── Score Engine ─────────────────────────────────────────────────────────────
function getScoreColor(s) {
    if (s >= 80) return 'var(--score-excellent)';
    if (s >= 60) return 'var(--score-great)';
    if (s >= 45) return 'var(--score-good)';
    if (s >= 30) return 'var(--score-fair)';
    return 'var(--score-poor)';
}
function getScoreHex(s) {
    if (s >= 80) return '#22c55e';
    if (s >= 60) return '#4ade80';
    if (s >= 45) return '#a3e635';
    if (s >= 30) return '#f59e0b';
    return '#ef4444';
}
function getScoreLabel(s) {
    if (s >= 80) return 'EXCELLENT';
    if (s >= 60) return 'GREAT';
    if (s >= 45) return 'GOOD';
    if (s >= 30) return 'FAIR';
    return 'POOR';
}

function calculateFishingScore(weather, solunar) {
    if (!weather) return { total: 0, factors: {} };
    const pressureTrend = weather.pressure_trend || 0;
    let pressureScore = 50;
    if (pressureTrend < -1) pressureScore = 85;
    else if (pressureTrend < 0) pressureScore = 70;
    else if (pressureTrend > 1) pressureScore = 30;
    else pressureScore = 55;

    let windScore = 90;
    const ws = weather.windspeed || 0;
    if (ws < 5) windScore = 70;
    else if (ws < 12) windScore = 90;
    else if (ws < 20) windScore = 65;
    else windScore = 30;

    let tempScore = 40;
    const t = weather.temperature || 32;
    if (t >= 55 && t <= 75) tempScore = 90;
    else if (t >= 45 && t <= 80) tempScore = 70;
    else if (t >= 35 && t <= 85) tempScore = 50;
    else tempScore = 30;

    let conditionScore = 80;
    const code = weather.weathercode || 0;
    if (code <= 3) conditionScore = 90;
    else if (code <= 48) conditionScore = 75;
    else if (code <= 67) conditionScore = 50;
    else conditionScore = 30;

    let moonScore = 50;
    if (solunar) {
        const illum = solunar.illumination * 100;
        if (illum < 25 || illum > 75) moonScore = 80;
        else if (illum > 40 && illum < 60) moonScore = 40;
        else moonScore = 60;
    }

    let solunarScore = 50;
    if (solunar) {
        const now = new Date();
        const h = now.getHours() + now.getMinutes() / 60;
        const majorPeaks = solunar.majorPeaks || [];
        const minorPeaks = solunar.minorPeaks || [];
        let nearMajor = majorPeaks.some(p => Math.abs(h - p) < 1.5);
        let nearMinor = minorPeaks.some(p => Math.abs(h - p) < 1);
        if (nearMajor) solunarScore = 100;
        else if (nearMinor) solunarScore = 80;
        else solunarScore = 45;
    }

    const total = Math.round(
        solunarScore * 0.25 + pressureScore * 0.20 + windScore * 0.15 +
        conditionScore * 0.15 + tempScore * 0.10 + moonScore * 0.15
    );

    return {
        total: Math.max(10, Math.min(99, total)),
        factors: {
            solunar: solunarScore, pressure: pressureScore, wind: windScore,
            conditions: conditionScore, waterTemp: tempScore, moonPhase: moonScore,
        }
    };
}

function calculateSpeciesScores(baseScore, weather) {
    const t = weather ? weather.temperature : 32;
    return SPECIES_DB.map(sp => {
        let modifier = 0;
        if (sp.name.includes('Bass')) modifier = t > 50 ? 10 : -5;
        if (sp.name.includes('Pike')) modifier = t < 60 ? 8 : -3;
        if (sp.name.includes('Crappie')) modifier = t < 55 ? 15 : 0;
        if (sp.name.includes('Walleye')) modifier = (t > 45 && t < 65) ? 12 : -5;
        if (sp.name.includes('Bluegill')) modifier = t > 55 ? 5 : -8;
        if (sp.name.includes('Perch')) modifier = t < 60 ? 6 : -4;
        const score = Math.max(15, Math.min(99, baseScore + modifier + Math.round((Math.random()-0.5)*10)));
        return { ...sp, score };
    }).sort((a, b) => b.score - a.score);
}

// ─── API ──────────────────────────────────────────────────────────────────────
async function fetchWeather(lat, lng) {
    try {
        const url = `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lng}&current=temperature_2m,relative_humidity_2m,apparent_temperature,precipitation,weather_code,pressure_msl,surface_pressure,wind_speed_10m,wind_direction_10m,wind_gusts_10m,cloud_cover&hourly=temperature_2m,precipitation_probability,weather_code,wind_speed_10m,pressure_msl,cloud_cover&daily=weather_code,temperature_2m_max,temperature_2m_min,precipitation_probability_max,sunrise,sunset&temperature_unit=fahrenheit&wind_speed_unit=mph&precipitation_unit=inch&timezone=America%2FDetroit&forecast_days=7`;
        const res = await fetch(url);
        const data = await res.json();
        return data;
    } catch (e) {
        console.error('Weather fetch error:', e);
        return null;
    }
}

function computeSolunar(lat, lng) {
    const now = new Date();
    const times = SunCalc.getTimes(now, lat, lng);
    const moonTimes = SunCalc.getMoonTimes(now, lat, lng);
    const moonIllum = SunCalc.getMoonIllumination(now);
    const moonPos = SunCalc.getMoonPosition(now, lat, lng);

    const transitHour = 12 + (moonPos.azimuth * 12 / Math.PI);
    const antiTransit = (transitHour + 12) % 24;
    const rise = moonTimes.rise ? moonTimes.rise.getHours() + moonTimes.rise.getMinutes()/60 : transitHour - 6;
    const set = moonTimes.set ? moonTimes.set.getHours() + moonTimes.set.getMinutes()/60 : transitHour + 6;

    return {
        sunrise: times.sunrise, sunset: times.sunset,
        moonrise: moonTimes.rise, moonset: moonTimes.set,
        illumination: moonIllum.fraction,
        phase: moonIllum.phase,
        phaseName: moonIllum.phase < 0.125 ? 'New Moon' : moonIllum.phase < 0.25 ? 'Waxing Crescent' : moonIllum.phase < 0.375 ? 'First Quarter' : moonIllum.phase < 0.5 ? 'Waxing Gibbous' : moonIllum.phase < 0.625 ? 'Full Moon' : moonIllum.phase < 0.75 ? 'Waning Gibbous' : moonIllum.phase < 0.875 ? 'Last Quarter' : 'Waning Crescent',
        majorPeaks: [transitHour % 24, antiTransit % 24],
        minorPeaks: [rise % 24, set % 24],
    };
}

function fmtTime(date) {
    if (!date) return '--:--';
    let h = date.getHours(), m = date.getMinutes();
    const ampm = h >= 12 ? 'PM' : 'AM';
    h = h % 12 || 12;
    return `${h}:${m.toString().padStart(2,'0')} ${ampm}`;
}

function fmtHour(h) {
    const ampm = h < 12 ? 'a' : 'p';
    const hr = h === 0 ? 12 : h > 12 ? h - 12 : h;
    return `${hr}${ampm}`;
}

// ─── Rendering ────────────────────────────────────────────────────────────────
function renderForecast() {
    const el = document.getElementById('screen-home');
    const lake = state.currentLake;
    const w = state.weather;
    const sol = state.solunar;
    const score = calculateFishingScore(w ? {
        temperature: w?.current?.temperature_2m,
        windspeed: w?.current?.wind_speed_10m,
        pressure_trend: 0,
        weathercode: w?.current?.weather_code,
    } : null, sol);

    const hourly = [];
    const nowH = new Date().getHours();
    if (w && w.hourly) {
        for (let i = 0; i < 24; i++) {
            const idx = nowH + i;
            if (idx >= w.hourly.time.length) break;
            const hScore = calculateFishingScore({
                temperature: w.hourly.temperature_2m[idx],
                windspeed: w.hourly.wind_speed_10m[idx],
                pressure_trend: idx > 0 ? (w.hourly.pressure_msl[idx] - w.hourly.pressure_msl[idx-1]) : 0,
                weathercode: w.hourly.weather_code[idx],
            }, sol);
            hourly.push({
                hour: fmtHour((nowH + i) % 24),
                label: `${((nowH+i)%24===0?12:(nowH+i)%24>12?(nowH+i)%24-12:(nowH+i)%24)}:00 ${(nowH+i)%24<12?'AM':'PM'}`,
                score: hScore.total,
                temp: Math.round(w.hourly.temperature_2m[idx]),
                isNow: i === 0,
            });
        }
    }

    const bestWindow = hourly.length > 0 ? hourly.reduce((b, h) => h.score > b.score ? h : b, hourly[0]) : { label: '--', score: 0 };
    const currentTemp = w ? Math.round(w.current.temperature_2m) : '--';
    const currentWind = w ? Math.round(w.current.wind_speed_10m) : '--';
    const windDir = w ? ['N','NE','E','SE','S','SW','W','NW'][Math.round(w.current.wind_direction_10m / 45) % 8] : '';
    const pressure = w ? Math.round(w.current.pressure_msl) : '--';
    const pressureArrow = '↓';
    const scoreColor = getScoreHex(score.total);
    const scoreColorVar = getScoreColor(score.total);

    const factors = [
        { icon:'🌙', label:'Solunar', value:score.factors.solunar||50 },
        { icon:'📊', label:'Pressure', value:score.factors.pressure||50 },
        { icon:'🌕', label:'Moon Phase', value:score.factors.moonPhase||50 },
        { icon:'🌡️', label:'Water Temp', value:score.factors.waterTemp||50 },
        { icon:'💨', label:'Wind', value:score.factors.wind||50 },
        { icon:'☁️', label:'Conditions', value:score.factors.conditions||50 },
    ];

    // Weekly
    const weekly = [];
    const dayNames = ['Sun','Mon','Tue','Wed','Thu','Fri','Sat'];
    const weatherIcons = {0:'☀️',1:'⛅',2:'⛅',3:'☁️',45:'🌫️',48:'🌫️',51:'🌦️',53:'🌧️',55:'🌧️',61:'🌧️',63:'🌧️',65:'🌧️',71:'🌨️',73:'🌨️',75:'🌨️',80:'🌦️',81:'🌧️',82:'🌧️',95:'⛈️'};
    if (w && w.daily) {
        for (let i = 0; i < 7; i++) {
            const d = new Date(w.daily.time[i]);
            const avgTemp = (w.daily.temperature_2m_max[i] + w.daily.temperature_2m_min[i]) / 2;
            const dScore = calculateFishingScore({
                temperature: avgTemp, windspeed: 10, pressure_trend: 0, weathercode: w.daily.weather_code[i]
            }, sol);
            weekly.push({
                day: i === 0 ? 'TODAY' : dayNames[d.getDay()],
                isToday: i === 0,
                high: Math.round(w.daily.temperature_2m_max[i]),
                low: Math.round(w.daily.temperature_2m_min[i]),
                score: dScore.total,
                icon: weatherIcons[w.daily.weather_code[i]] || '☀️',
                precip: w.daily.precipitation_probability_max[i] || 0,
            });
        }
    }

    // Solunar periods
    const solHTML = sol ? `
        <div class="solunar-grid">
            ${sol.majorPeaks.map((p,i) => {
                const sh = Math.floor(p), sm = Math.round((p-sh)*60);
                const eh = Math.floor(p+2), em = Math.round(((p+2)-eh)*60);
                const startStr = `${sh%12||12}:${sm.toString().padStart(2,'0')} ${sh<12?'AM':'PM'}`;
                const endStr = `${eh%12||12}:${em.toString().padStart(2,'0')} ${eh<12?'AM':'PM'}`;
                return `<div class="solunar-period major"><div class="solunar-type" style="color:var(--gold)">★ MAJOR PERIOD</div><div class="solunar-time">${startStr} – ${endStr}</div></div>`;
            }).join('')}
            ${sol.minorPeaks.map((p,i) => {
                const sh = Math.floor(p), sm = Math.round((p-sh)*60);
                const eh = Math.floor(p+1), em = Math.round(((p+1)-eh)*60);
                const startStr = `${sh%12||12}:${sm.toString().padStart(2,'0')} ${sh<12?'AM':'PM'}`;
                const endStr = `${eh%12||12}:${em.toString().padStart(2,'0')} ${eh<12?'AM':'PM'}`;
                return `<div class="solunar-period"><div class="solunar-type" style="color:var(--text-muted)">MINOR PERIOD</div><div class="solunar-time">${startStr} – ${endStr}</div></div>`;
            }).join('')}
        </div>
        <div class="solunar-chips">
            <div class="solunar-chip"><span class="icon">🌅</span>Rise ${fmtTime(sol.sunrise)}</div>
            <div class="solunar-chip"><span class="icon">🌇</span>Set ${fmtTime(sol.sunset)}</div>
            <div class="solunar-chip"><span class="icon">🌙</span>Rise ${fmtTime(sol.moonrise)}</div>
            <div class="solunar-chip"><span class="icon">🌘</span>Set ${fmtTime(sol.moonset)}</div>
            <div class="solunar-chip"><span class="icon">🌓</span>${Math.round(sol.illumination*100)}% ${sol.phaseName}</div>
        </div>
    ` : '<div style="color:var(--text-muted);font-size:12px">Loading solunar data...</div>';

    // Top species
    state.speciesScores = calculateSpeciesScores(score.total, w ? { temperature: w.current?.temperature_2m } : null);
    const topSpecies = state.speciesScores.slice(0, 3);

    const r = 47, circ = 2 * Math.PI * r;
    const dashOffset = circ - (score.total / 100) * circ;

    el.innerHTML = `
        <!-- Hero Score -->
        <div class="glass mt-12" style="padding:24px 20px">
            <div class="flex items-center justify-between">
                <div>
                    <div class="section-title" style="margin-bottom:4px;color:var(--text-muted)">TODAY'S FORECAST</div>
                    <div style="font-family:var(--font-display);font-size:22px;font-weight:700;margin-bottom:2px">${lake.name}</div>
                    <div style="font-size:12px;color:var(--text-secondary)">${lake.location} · ${lake.acres} acres</div>
                    <div class="flex gap-16" style="margin-top:14px">
                        <div class="flex items-center gap-4"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><path d="M14 14.76V3.5a2.5 2.5 0 00-5 0v11.26a4.5 4.5 0 105 0z"/></svg><span style="font-size:12px;color:var(--text-secondary)">${currentTemp}°F</span></div>
                        <div class="flex items-center gap-4"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><path d="M9.59 4.59A2 2 0 1111 8H2m10.59 11.41A2 2 0 1014 16H2m15.73-8.27A2.5 2.5 0 1119.5 12H2"/></svg><span style="font-size:12px;color:var(--text-secondary)">${currentWind} mph ${windDir}</span></div>
                        <div class="flex items-center gap-4"><svg width="13" height="13" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><circle cx="12" cy="12" r="10"/><path d="M12 6v6l4 2"/></svg><span style="font-size:12px;color:var(--text-secondary)">${pressure} mb ${pressureArrow}</span></div>
                    </div>
                </div>
                <div class="score-gauge" style="width:110px;height:110px">
                    <svg width="110" height="110">
                        <circle cx="55" cy="55" r="${r}" fill="none" stroke="rgba(255,255,255,0.06)" stroke-width="8"/>
                        <circle cx="55" cy="55" r="${r}" fill="none" stroke="${scoreColor}" stroke-width="8" stroke-dasharray="${circ}" stroke-dashoffset="${dashOffset}" stroke-linecap="round" style="transition:stroke-dashoffset 1.2s cubic-bezier(0.34,1.56,0.64,1);filter:drop-shadow(0 0 8px ${scoreColor}60)"/>
                    </svg>
                    <div class="value">
                        <span class="number" style="font-size:35px;color:${scoreColor}">${score.total}</span>
                        <span class="label">${getScoreLabel(score.total)}</span>
                    </div>
                </div>
            </div>
            <div class="peak-banner">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polygon points="13 2 3 14 12 14 11 22 21 10 12 10 13 2"/></svg>
                <div><span class="peak-label">PEAK WINDOW</span><span class="peak-time">${bestWindow.label} — Score ${bestWindow.score}</span></div>
            </div>
        </div>

        <!-- Hourly Timeline -->
        <div class="glass" style="padding:16px 12px;margin-top:12px">
            <div class="section-title" style="padding-left:8px;margin-bottom:12px">24-HOUR FORECAST</div>
            <div class="hourly-scroll">
                ${hourly.map((h,i) => {
                    const c = getScoreHex(h.score);
                    return `<div class="hourly-cell ${h.isNow?'now':''}" style="${h.isNow?`background:${c}18;border-color:${c}40`:''}">
                        <span style="font-size:10px;color:${h.isNow?c:'var(--text-muted)'};font-weight:${h.isNow?700:500}">${h.hour}</span>
                        <div class="hourly-bar-container" style="background:${c}20">
                            <div class="hourly-bar" style="height:${h.score}%;background:linear-gradient(to top,${c},${c}88)"></div>
                        </div>
                        <span style="font-family:var(--font-display);font-size:13px;font-weight:700;color:${c}">${h.score}</span>
                        <span style="font-size:9px;color:var(--text-muted)">${h.temp}°</span>
                    </div>`;
                }).join('')}
            </div>
        </div>

        <!-- Solunar -->
        <div class="glass p-16" style="margin-top:12px">
            <div class="section-title mb-14">SOLUNAR ACTIVITY</div>
            ${solHTML}
        </div>

        <!-- Factor Breakdown -->
        <div class="glass p-16" style="margin-top:12px">
            <div class="section-title" style="margin-bottom:10px">FACTOR BREAKDOWN</div>
            ${factors.map(f => {
                const c = getScoreHex(f.value);
                return `<div class="factor-row">
                    <span class="factor-icon">${f.icon}</span>
                    <span class="factor-label">${f.label}</span>
                    <div class="factor-track"><div class="factor-fill" style="width:${f.value}%;background:linear-gradient(90deg,${c},${c}cc);box-shadow:0 0 8px ${c}40"></div></div>
                    <span class="factor-value" style="color:${c}">${f.value}</span>
                </div>`;
            }).join('')}
        </div>

        <!-- 7-Day Outlook -->
        <div class="glass p-16" style="margin-top:12px">
            <div class="section-title mb-12">7-DAY OUTLOOK</div>
            <div class="weekly-row">
                ${weekly.map(d => {
                    const c = getScoreHex(d.score);
                    return `<div class="weekly-day ${d.isToday?'today':''}">
                        <span class="name">${d.day}</span>
                        <span class="emoji">${d.icon}</span>
                        <div class="temps">${d.high}° / ${d.low}°</div>
                        <div class="weekly-score" style="border-color:${c};background:${c}15;color:${c}">${d.score}</div>
                        ${d.precip > 0 ? `<div class="precip">${d.precip}%</div>` : ''}
                    </div>`;
                }).join('')}
            </div>
        </div>

        <!-- Top Species -->
        <div class="glass p-16" style="margin-top:12px">
            <div class="flex justify-between items-center mb-12">
                <div class="section-title">TOP SPECIES TODAY</div>
                <span style="font-size:11px;color:var(--teal);cursor:pointer" onclick="switchScreen('species')">View All →</span>
            </div>
            ${topSpecies.map((sp,i) => {
                const c = getScoreHex(sp.score);
                return `<div class="quick-species-row">
                    <span class="quick-species-emoji">${sp.emoji}</span>
                    <div class="quick-species-info"><div class="quick-species-name">${sp.name}</div><div class="quick-species-meta">${sp.depth} · ${sp.baits[0]}</div></div>
                    <div class="quick-species-score" style="border-color:${c};background:${c}15;color:${c}">${sp.score}</div>
                </div>`;
            }).join('')}
        </div>
    `;
}

function renderSpecies() {
    const el = document.getElementById('screen-species');
    const species = state.speciesScores.length ? state.speciesScores : calculateSpeciesScores(50, { temperature: 32 });
    el.innerHTML = `
        <div style="padding:16px 4px 8px">
            <div style="font-family:var(--font-display);font-size:22px;font-weight:700">Species Guide</div>
            <div style="font-size:12px;color:var(--text-secondary);margin-top:2px">AI-powered targeting for today's conditions</div>
        </div>
        ${species.map(sp => {
            const c = getScoreHex(sp.score);
            const locked = sp.premium;
            return `<div class="glass" style="padding:16px;margin-top:8px;${locked?'opacity:0.6':''}position:relative;overflow:hidden">
                ${locked ? '<div style="position:absolute;top:10px;right:10px"><span class="pro-badge"><svg viewBox="0 0 24 24"><path d="M2 4l3 12h14l3-12-5.5 5L12 2l-4.5 5L2 4z"/></svg> PRO</span></div>' : ''}
                <div class="species-card">
                    <div class="species-avatar" style="background:${c}15;border:2px solid ${c}40">${sp.emoji}</div>
                    <div style="flex:1">
                        <div class="flex items-center gap-8">
                            <span class="species-name">${sp.name}</span>
                            <span class="species-score-badge" style="color:${c};background:${c}15">${sp.score}</span>
                        </div>
                        <div class="species-desc">${locked ? 'Upgrade to Pro for full species analysis...' : sp.technique}</div>
                        ${!locked ? `<div class="species-tags">
                            <span class="species-tag depth"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="var(--teal)" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg> ${sp.depth}</span>
                            ${sp.baits.map(b => `<span class="species-tag bait">${b}</span>`).join('')}
                        </div>` : ''}
                    </div>
                </div>
            </div>`;
        }).join('')}
    `;
}

function renderCatchLog() {
    const el = document.getElementById('screen-log');
    const saved = getCatches();
    const allEntries = saved.length > 0 ? saved : null;

    const demoHTML = allEntries ? '' : CATCH_LOG.map(function(c) { return `
        <div class="catch-entry">
            <div class="catch-header">
                <div><div class="catch-species">${c.species}</div><div class="catch-meta">${c.lake} · ${c.date}</div></div>
                <div class="catch-badges">
                    ${c.weight ? `<span class="catch-badge weight">${c.weight}</span>` : ''}
                    ${c.length ? `<span class="catch-badge length">${c.length}</span>` : ''}
                </div>
            </div>
            <div class="catch-details">
                <span class="catch-detail" style="color:var(--text-muted)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><polyline points="12 6 12 12 16 14"/></svg> ${c.time}</span>
                <span class="catch-detail" style="color:var(--gold-light)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg> ${c.bait}</span>
            </div>
            ${c.notes ? `<div class="catch-notes">"${c.notes}"</div>` : ''}
        </div>
    `;}).join('');

    const savedHTML = allEntries ? allEntries.map(function(c) { return `
        <div class="catch-entry">
            <div class="catch-header">
                <div>
                    <div class="catch-species">${c.species}</div>
                    <div class="catch-meta">${c.lake} · ${c.date} · ${c.time}</div>
                </div>
                <div class="catch-badges">
                    ${c.weight ? `<span class="catch-badge weight">${c.weight} lbs</span>` : ''}
                    ${c.length ? `<span class="catch-badge length">${c.length}"</span>` : ''}
                </div>
            </div>
            <div class="catch-details">
                ${c.bait ? `<span class="catch-detail" style="color:var(--gold-light)"><svg width="11" height="11" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="10"/><circle cx="12" cy="12" r="1"/></svg> ${c.bait}</span>` : ''}
                ${c.depth ? `<span class="catch-detail" style="color:var(--text-muted)">↓ ${c.depth}ft</span>` : ''}
                <button class="catch-delete-btn" onclick="deleteCatch(${c.id})">Delete</button>
            </div>
            ${c.notes ? `<div class="catch-notes">"${c.notes}"</div>` : ''}
        </div>
    `;}).join('') : '';

    const totalCount = allEntries ? allEntries.length : 47;
    const bestWeight = allEntries ? (allEntries.reduce(function(b, c) { return (c.weight || 0) > b ? (c.weight || 0) : b; }, 0) + ' lbs') : '12.4 lbs';
    const monthCount = allEntries ? allEntries.filter(function(c) { return Date.now() - c.timestamp < 30*24*60*60*1000; }).length : 8;

    el.innerHTML = `
        <div class="flex justify-between items-center" style="padding:16px 4px 8px">
            <div>
                <div style="font-family:var(--font-display);font-size:22px;font-weight:700">Catch Log</div>
                <div style="font-size:12px;color:var(--text-secondary);margin-top:2px">${totalCount} catches logged</div>
            </div>
            <button class="log-btn" onclick="openCatchModal()"><svg width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Log Catch</button>
        </div>
        <div class="stats-grid" style="margin-top:8px">
            <div class="glass stat-card" style="padding:14px 12px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3"/><path d="M14 13c2 1 4 3 7 3"/></svg><div class="stat-value">${totalCount}</div><div class="stat-label">TOTAL CATCHES</div></div>
            <div class="glass stat-card" style="padding:14px 12px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><path d="M6 9H4.5a2.5 2.5 0 010-5C7 4 6 9 6 9zm12 0h1.5a2.5 2.5 0 000-5C17 4 18 9 18 9zm-2 11H8s0-4 2-7h4c2 3 2 7 2 7zm-3-11V4l3 1-3 1"/></svg><div class="stat-value">${bestWeight}</div><div class="stat-label">BEST WEIGHT</div></div>
            <div class="glass stat-card" style="padding:14px 12px"><svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="var(--gold)" stroke-width="2"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/></svg><div class="stat-value">${monthCount}</div><div class="stat-label">THIS MONTH</div></div>
        </div>
        <div class="glass" style="padding:4px 16px;margin-top:12px">
            ${savedHTML || demoHTML}
        </div>
    `;
}

function renderMap() {
    const el = document.getElementById('screen-map');
    const lake = state.currentLake;
    el.innerHTML = `
        <div style="padding:16px 4px 8px">
            <div style="font-family:var(--font-display);font-size:22px;font-weight:700">Lake Map</div>
            <div style="font-size:12px;color:var(--text-secondary);margin-top:2px">${lake.name} · ${lake.acres} acres · Max ${lake.maxDepth}ft</div>
        </div>
        <div id="map-container" class="glass" style="margin-top:8px;padding:0;overflow:hidden;height:360px">
            <div id="maplibre" style="width:100%;height:100%"></div>
            <div class="map-controls">
                <button class="map-mode-btn" onclick="setMapStyle('sat')">SAT</button>
                <button class="map-mode-btn" onclick="setMapStyle('topo')">TOPO</button>
                <button class="map-mode-btn active" onclick="setMapStyle('hyb')">HYB</button>
            </div>
        </div>
        <div class="glass p-16" style="margin-top:12px">
            <div class="section-title mb-12">LAKE DETAILS</div>
            <div class="lake-info-grid">
                <div class="lake-info-item"><div class="lake-info-label">SURFACE AREA</div><div class="lake-info-value">${lake.acres} acres</div></div>
                <div class="lake-info-item"><div class="lake-info-label">MAX DEPTH</div><div class="lake-info-value">${lake.maxDepth} ft</div></div>
                <div class="lake-info-item"><div class="lake-info-label">COORDINATES</div><div class="lake-info-value">${lake.lat}°N, ${Math.abs(lake.lng)}°W</div></div>
                <div class="lake-info-item"><div class="lake-info-label">SPECIES</div><div class="lake-info-value">${lake.species.length} confirmed</div></div>
            </div>
        </div>
        <div class="glass p-16" style="margin-top:12px">
            <div class="section-title mb-12">SPECIES PRESENT</div>
            <div class="species-chip-list">${lake.species.map(s => `<span class="species-chip">${s}</span>`).join('')}</div>
        </div>
    `;
    setTimeout(initMap, 100);
}

function initMap() {
    const lake = state.currentLake;
    if (state.mapInstance) { state.mapInstance.remove(); state.mapInstance = null; }
    try {
        const map = new maplibregl.Map({
            container: 'maplibre',
            style: { version: 8, sources: {
                'satellite': { type: 'raster', tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'], tileSize: 256, maxzoom: 19 },
                'labels': { type: 'raster', tiles: ['https://services.arcgisonline.com/ArcGIS/rest/services/Reference/World_Boundaries_and_Places/MapServer/tile/{z}/{y}/{x}'], tileSize: 256, maxzoom: 19 }
            }, layers: [
                { id: 'sat', type: 'raster', source: 'satellite' },
                { id: 'labels', type: 'raster', source: 'labels' }
            ]},
            center: [lake.lng, lake.lat],
            zoom: 14.5,
            attributionControl: false,
        });
        map.addControl(new maplibregl.NavigationControl({ showCompass: false }), 'bottom-right');
        map.addControl(new maplibregl.AttributionControl({ compact: true }), 'bottom-right');
        state.mapInstance = map;
        window._map = map;
    } catch(e) { console.error('Map init error:', e); }
}

function setMapStyle(style) {
    const map = window._map;
    if (!map) return;

    const tileSources = {
        sat: {
            type: 'raster',
            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
            tileSize: 256, maxzoom: 19
        },
        topo: {
            type: 'raster',
            tiles: ['https://tile.opentopomap.org/{z}/{x}/{y}.png'],
            tileSize: 256, maxzoom: 17,
            attribution: '© OpenTopoMap'
        },
        hyb: {
            type: 'raster',
            tiles: ['https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'],
            tileSize: 256, maxzoom: 19
        }
    };

    if (map.getLayer('base-tiles')) map.removeLayer('base-tiles');
    if (map.getSource('base-source')) map.removeSource('base-source');

    map.addSource('base-source', tileSources[style]);
    map.addLayer({ id: 'base-tiles', type: 'raster', source: 'base-source' },
        map.getStyle().layers[0]?.id);

    document.querySelectorAll('.map-mode-btn').forEach(btn => {
        btn.classList.toggle('active', btn.textContent.trim().toLowerCase() === style);
    });
}

function renderPremium() {
    const el = document.getElementById('screen-premium');
    const features = [
        { icon:'M12 2C6.48 2 2 6.48 2 12s4.48 10 10 10c.83 0 1.64-.1 2.41-.3M14 13c2 1 4 3 7 3', title:'All Species Unlocked', desc:'Full targeting analysis for every species in every lake' },
        { icon:'M12 2l10 6.5v7L12 22 2 15.5v-7L12 2zM12 22V8.5M22 8.5l-10 6M2 8.5l10 6', title:'Unlimited Lakes', desc:'Search, save, and track conditions on any lake nationwide' },
        { icon:'M12 22c5.523 0 10-4.477 10-10S17.523 2 12 2 2 6.477 2 12s4.477 10 10 10zM12 12l-4-4m4 4l4-4m-4 4v6', title:'AI Spot Predictions', desc:'Machine learning hotspot predictions based on current conditions' },
        { icon:'M18 8A6 6 0 006 8c0 7-3 9-3 9h18s-3-2-3-9M13.73 21a2 2 0 01-3.46 0', title:'Smart Alerts', desc:'Get notified when conditions are perfect for your target species' },
        { icon:'M23 6l-9.5 9.5-5-5L1 18', title:'Advanced Analytics', desc:'Catch statistics, personal bests, seasonal trends, and pattern analysis' },
        { icon:'M23 19a2 2 0 01-2 2H3a2 2 0 01-2-2V8a2 2 0 012-2h4l2-3h6l2 3h4a2 2 0 012 2zM12 13a4 4 0 100-8 4 4 0 000 8z', title:'Photo Catch Log', desc:'Unlimited photo storage and GPS-tagged catch entries' },
        { icon:'M4 12v8a2 2 0 002 2h12a2 2 0 002-2v-8M16 6l-4-4-4 4M12 2v13', title:'Offline Maps', desc:'Download lake maps and forecasts for areas with no cell service' },
    ];

    el.innerHTML = `
        <div class="premium-hero">
            <div class="premium-icon"><svg viewBox="0 0 24 24" stroke-width="2"><path d="M2 4l3 12h14l3-12-5.5 5L12 2l-4.5 5L2 4z"/><path d="M5 16l-1 4h16l-1-4"/></svg></div>
            <div class="premium-title">FishCast Pro</div>
            <div class="premium-subtitle">Unlock the full power of AI-driven fishing intelligence</div>
        </div>
        <div class="pricing-grid" style="margin-top:16px">
            <div class="glass pricing-card"><div class="pricing-period">MONTHLY</div><div class="pricing-price">$9.99</div><div class="pricing-sub">/month</div></div>
            <div class="glass pricing-card popular"><div class="pricing-save">SAVE 42%</div><div class="pricing-period">ANNUAL</div><div class="pricing-price">$5.83</div><div class="pricing-sub">/mo billed annually</div></div>
        </div>
        <div class="glass p-20" style="margin-top:16px">
            <div class="section-title" style="margin-bottom:16px">EVERYTHING IN PRO</div>
            ${features.map(f => `
                <div class="feature-row">
                    <div class="feature-icon-wrap"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="${f.icon}"/></svg></div>
                    <div><div class="feature-title">${f.title}</div><div class="feature-desc">${f.desc}</div></div>
                </div>
            `).join('')}
        </div>
        <button class="cta-btn" style="margin-top:16px">Start 7-Day Free Trial</button>
        <div class="cta-sub">Cancel anytime · No commitment · Instant access</div>
    `;
}

// ─── Navigation ───────────────────────────────────────────────────────────────
function switchScreen(name) {
    state.currentScreen = name;
    document.querySelectorAll('.screen').forEach(s => s.classList.remove('active'));
    document.getElementById('screen-' + name).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.toggle('active', n.dataset.screen === name));
    document.getElementById('content').scrollTop = 0;

    if (name === 'home') renderForecast();
    else if (name === 'species') renderSpecies();
    else if (name === 'log') renderCatchLog();
    else if (name === 'map') renderMap();
    else if (name === 'premium') renderPremium();
}

// ─── Lake Modal ───────────────────────────────────────────────────────────────
function openLakeModal() {
    const modal = document.getElementById('lake-modal');
    const sheet = document.getElementById('lake-sheet');
    sheet.innerHTML = `
        <div class="lake-sheet-header">
            <div class="lake-sheet-title">Select Lake</div>
            <button class="lake-close-btn" onclick="closeLakeModal()"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="6" x2="6" y2="18"/><line x1="6" y1="6" x2="18" y2="18"/></svg></button>
        </div>
        <div class="lake-search"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="var(--text-muted)" stroke-width="2"><circle cx="11" cy="11" r="8"/><line x1="21" y1="21" x2="16.65" y2="16.65"/></svg><span>Search 50,000+ lakes...</span><span class="pro-badge"><svg viewBox="0 0 24 24"><path d="M2 4l3 12h14l3-12-5.5 5L12 2l-4.5 5L2 4z"/></svg> PRO</span></div>
        <div class="lake-list-label">SAVED LAKES</div>
        ${LAKES.filter(l=>l.saved).map(l => `
            <button class="lake-option ${l.id===state.currentLake.id?'selected':''}" onclick="selectLake(${l.id})">
                <div class="lake-option-icon"><svg viewBox="0 0 24 24" fill="none" stroke-width="2"><path d="M2 15c6.667-6 13.333 0 20-6"/><path d="M2 19c6.667-6 13.333 0 20-6"/></svg></div>
                <div style="flex:1"><div class="lake-option-name">${l.name}</div><div class="lake-option-meta">${l.location} · ${l.acres} acres</div></div>
                ${l.id===state.currentLake.id ? '<div class="lake-selected-dot"></div>' : ''}
            </button>
        `).join('')}
        <button class="add-lake-btn"><svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="12" y1="5" x2="12" y2="19"/><line x1="5" y1="12" x2="19" y2="12"/></svg> Add New Lake</button>
    `;
    modal.classList.add('open');
}
function closeLakeModal() { document.getElementById('lake-modal').classList.remove('open'); }
function selectLake(id) {
    state.currentLake = LAKES.find(l => l.id === id);
    document.getElementById('header-lake-name').textContent = state.currentLake.name;
    closeLakeModal();
    loadData();
}

// ─── Init ─────────────────────────────────────────────────────────────────────
async function loadData() {
    const lake = state.currentLake;
    state.solunar = computeSolunar(lake.lat, lake.lng);
    state.weather = await fetchWeather(lake.lat, lake.lng);
    if (state.currentScreen === 'home') renderForecast();
    else if (state.currentScreen === 'species') renderSpecies();
}

// ═══ TOKEN GATE SYSTEM ═══════════════════════════════════════════════════════
const EVAL_TOKENS = {
    'FC-2026-7K3X-QN91': { name: 'Alpha',   maxUses: 5 },
    'FC-2026-4M8R-DP52': { name: 'Bravo',   maxUses: 5 },
    'FC-2026-9T2W-HJ67': { name: 'Charlie', maxUses: 5 },
    'FC-2026-1B5V-YC84': { name: 'Delta',   maxUses: 5 },
    'FC-2026-6F9L-ZA38': { name: 'Echo',    maxUses: 5 },
    'FC-2026-MASTER-00': { name: 'Master',  maxUses: 999 },
};
const SESSION_DURATION = 60 * 60 * 1000; // 1 hour
let sessionTimer = null;

function formatGateInput(value) {
    const clean = value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
    const parts = [];
    if (clean.length > 0) parts.push(clean.slice(0, 2));
    if (clean.length > 2) parts.push(clean.slice(2, 6));
    if (clean.length > 6) parts.push(clean.slice(6, 10));
    if (clean.length > 10) parts.push(clean.slice(10, 14));
    return parts.join('-');
}

function setupGateInput() {
    const input = document.getElementById('gate-token');
    const btn = document.getElementById('gate-submit');
    if (!input) return;

    input.addEventListener('input', function() {
        this.value = formatGateInput(this.value);
        btn.disabled = this.value.length < 16;
        this.classList.remove('error');
        document.getElementById('gate-error').textContent = '';
    });

    input.addEventListener('keydown', function(e) {
        if (e.key === 'Enter' && !btn.disabled) validateToken();
    });
}

function getTokenUsage() {
    try {
        return JSON.parse(localStorage.getItem('fc_token_usage') || '{}');
    } catch(e) { return {}; }
}

function recordTokenUse(token) {
    const usage = getTokenUsage();
    usage[token] = (usage[token] || 0) + 1;
    localStorage.setItem('fc_token_usage', JSON.stringify(usage));
    return usage[token];
}

function getTokenRemainingUses(token) {
    if (!EVAL_TOKENS[token]) return 0;
    const usage = getTokenUsage();
    return EVAL_TOKENS[token].maxUses - (usage[token] || 0);
}

function validateToken() {
    const input = document.getElementById('gate-token');
    const errorEl = document.getElementById('gate-error');
    const raw = input.value.replace(/[^A-Z0-9]/gi, '').toUpperCase();
    const token = Object.keys(EVAL_TOKENS).find(k =>
        k.replace(/[^A-Z0-9]/g, '') === raw
    );

    if (!token) {
        input.classList.add('error');
        errorEl.textContent = 'Invalid evaluation key. Contact your administrator.';
        setTimeout(() => input.classList.remove('error'), 600);
        return;
    }

    const remaining = getTokenRemainingUses(token);
    if (remaining <= 0) {
        input.classList.add('error');
        errorEl.textContent = 'This evaluation key has reached its usage limit. Contact your administrator.';
        setTimeout(() => input.classList.remove('error'), 600);
        return;
    }

    const useNumber = recordTokenUse(token);
    const session = {
        token: token,
        name: EVAL_TOKENS[token].name,
        useNumber: useNumber,
        maxUses: EVAL_TOKENS[token].maxUses,
        startedAt: Date.now(),
        expiresAt: Date.now() + SESSION_DURATION
    };
    localStorage.setItem('fc_eval_session', JSON.stringify(session));
    dismissGate();
}

function checkExistingSession() {
    try {
        const raw = localStorage.getItem('fc_eval_session');
        if (!raw) return false;
        const session = JSON.parse(raw);
        if (Date.now() > session.expiresAt) {
            localStorage.removeItem('fc_eval_session');
            return false;
        }
        return session;
    } catch(e) { return false; }
}

function dismissGate() {
    document.getElementById('eval-gate').classList.add('dismissed');
    startSessionTimer();
    startApp();
}

function startSessionTimer() {
    const timerEl = document.getElementById('session-timer');
    const barEl = timerEl.querySelector('.timer-bar');
    const labelEl = timerEl.querySelector('.timer-label');
    timerEl.style.display = 'block';

    const session = JSON.parse(localStorage.getItem('fc_eval_session'));
    if (!session) return;

    function update() {
        const remaining = Math.max(0, session.expiresAt - Date.now());
        const pct = (remaining / SESSION_DURATION) * 100;
        const mins = Math.floor(remaining / 60000);
        const secs = Math.floor((remaining % 60000) / 1000);
        barEl.style.width = pct + '%';
        labelEl.textContent = String(mins).padStart(2,'0') + ':' + String(secs).padStart(2,'0');

        if (remaining < 300000) {
            barEl.style.background = 'linear-gradient(90deg, var(--score-poor), var(--score-fair))';
            labelEl.style.color = 'var(--score-poor)';
            labelEl.style.borderColor = 'rgba(239,68,68,0.3)';
        }

        if (remaining <= 0) {
            clearInterval(sessionTimer);
            localStorage.removeItem('fc_eval_session');
            location.reload();
        }
    }
    update();
    sessionTimer = setInterval(update, 1000);
}

function showGate() {
    document.getElementById('eval-gate').classList.remove('dismissed');
    document.getElementById('session-timer').style.display = 'none';
    document.getElementById('splash').classList.add('hidden');
    setupGateInput();
    setTimeout(() => {
        const input = document.getElementById('gate-token');
        if (input) input.focus();
    }, 400);
}

// ─── App Start ────────────────────────────────────────────────────────────────
async function startApp() {
    await loadData();
    renderForecast();
    setTimeout(() => { document.getElementById('splash').classList.add('hidden'); }, 800);
    try { if ('wakeLock' in navigator) await navigator.wakeLock.request('screen'); } catch(e) {}
}

function init() {
    if ('serviceWorker' in navigator) {
        navigator.serviceWorker.register('sw.js').catch(e => console.log('SW reg failed:', e));
    }
    const session = checkExistingSession();
    if (session) {
        dismissGate();
    } else {
        showGate();
    }
}

// ─── Catch Log ────────────────────────────────────────────────────────────────
function openCatchModal() {
    const modal = document.getElementById('catch-modal');
    const select = document.getElementById('catch-species');
    select.innerHTML = '<option value="">Select species...</option>' +
        state.currentLake.species.map(function(s) { return `<option value="${s}">${s}</option>`; }).join('');
    modal.classList.add('open');
}
function closeCatchModal() {
    document.getElementById('catch-modal').classList.remove('open');
    ['catch-species','catch-weight','catch-length','catch-bait','catch-depth','catch-notes'].forEach(function(id) {
        const el = document.getElementById(id);
        if (el) el.value = '';
    });
}
function saveCatch() {
    const species = document.getElementById('catch-species').value;
    if (!species) { alert('Please select a species'); return; }
    const entry = {
        id: Date.now(),
        species: species,
        weight: parseFloat(document.getElementById('catch-weight').value) || null,
        length: parseFloat(document.getElementById('catch-length').value) || null,
        bait: document.getElementById('catch-bait').value.trim() || null,
        depth: parseFloat(document.getElementById('catch-depth').value) || null,
        notes: document.getElementById('catch-notes').value.trim() || null,
        lake: state.currentLake.name,
        date: new Date().toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' }),
        time: new Date().toLocaleTimeString('en-US', { hour: 'numeric', minute: '2-digit' }),
        timestamp: Date.now()
    };
    const catches = getCatches();
    catches.unshift(entry);
    localStorage.setItem('fc_catches', JSON.stringify(catches));
    closeCatchModal();
    renderCatchLog();
}
function getCatches() {
    try { return JSON.parse(localStorage.getItem('fc_catches') || '[]'); } catch(e) { return []; }
}
function deleteCatch(id) {
    if (!confirm('Delete this catch entry?')) return;
    const catches = getCatches().filter(function(c) { return c.id !== id; });
    localStorage.setItem('fc_catches', JSON.stringify(catches));
    renderCatchLog();
}

// ─── Settings ─────────────────────────────────────────────────────────────────
function openSettings() {
    document.getElementById('settings-panel').classList.add('open');
    loadSettingsState();
}
function closeSettings() {
    document.getElementById('settings-panel').classList.remove('open');
}
function setSetting(key, value, btn) {
    const settings = JSON.parse(localStorage.getItem('fc_settings') || '{}');
    settings[key] = value;
    localStorage.setItem('fc_settings', JSON.stringify(settings));
    btn.parentElement.querySelectorAll('.settings-opt').forEach(b => b.classList.remove('active'));
    btn.classList.add('active');
}
function toggleSetting(key, value) {
    const settings = JSON.parse(localStorage.getItem('fc_settings') || '{}');
    settings[key] = value;
    localStorage.setItem('fc_settings', JSON.stringify(settings));
}
function getSettings() {
    return JSON.parse(localStorage.getItem('fc_settings') || '{"tempUnit":"F","weightUnit":"lbs","lengthUnit":"in","peakAlerts":true,"solunarReminders":true}');
}
function loadSettingsState() {
    const s = getSettings();
    document.querySelectorAll('.settings-toggle-group').forEach(function(group) {
        const label = group.closest('.settings-row').querySelector('span').textContent.trim().toLowerCase();
        group.querySelectorAll('.settings-opt').forEach(function(btn) {
            const txt = btn.textContent.trim().replace('°', '');
            if (label === 'temperature') btn.classList.toggle('active', txt === s.tempUnit);
            else if (label === 'weight') btn.classList.toggle('active', txt === s.weightUnit);
            else if (label === 'length') btn.classList.toggle('active', txt === s.lengthUnit);
        });
    });
    const peakEl = document.getElementById('setting-peak-alerts');
    const solEl = document.getElementById('setting-solunar');
    if (peakEl) peakEl.checked = s.peakAlerts !== false;
    if (solEl) solEl.checked = s.solunarReminders !== false;
}

document.addEventListener('DOMContentLoaded', init);
</script>
</body>
</html>
